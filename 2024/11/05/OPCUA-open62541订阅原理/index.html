<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>OCPUA open62541-订阅监视 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="subscribe概念 订阅有发布间隔。订阅的发布间隔定义了订阅的循环执行速度。每次执行时，它都会尝试向客户端发送一条通知消息（NotificationMessage）。通知消息包含尚未报告给客户端的通知 通知信息（NotificationMessage）是对发布请求的响应，会被发送到客户端。发布请求通常会在收到时排队到会话中，如果有通知要报告，则会在每个发布周期将其中一个发布请求取消排队并由与该">
<meta property="og:type" content="article">
<meta property="og:title" content="OCPUA open62541-订阅监视">
<meta property="og:url" content="http://example.com/2024/11/05/OPCUA-open62541%E8%AE%A2%E9%98%85%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="subscribe概念 订阅有发布间隔。订阅的发布间隔定义了订阅的循环执行速度。每次执行时，它都会尝试向客户端发送一条通知消息（NotificationMessage）。通知消息包含尚未报告给客户端的通知 通知信息（NotificationMessage）是对发布请求的响应，会被发送到客户端。发布请求通常会在收到时排队到会话中，如果有通知要报告，则会在每个发布周期将其中一个发布请求取消排队并由与该">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-11-05T01:49:08.000Z">
<meta property="article:modified_time" content="2024-11-07T05:37:35.970Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-OPCUA-open62541订阅原理" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/11/05/OPCUA-open62541%E8%AE%A2%E9%98%85%E5%8E%9F%E7%90%86/" class="article-date">
  <time class="dt-published" datetime="2024-11-05T01:49:08.000Z" itemprop="datePublished">2024-11-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%9E%E4%B9%A0/">实习</a>►<a class="article-category-link" href="/categories/%E5%AE%9E%E4%B9%A0/baosight/">baosight</a>►<a class="article-category-link" href="/categories/%E5%AE%9E%E4%B9%A0/baosight/OPC-UA/">OPC_UA</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      OCPUA open62541-订阅监视
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="subscribe概念"><a href="#subscribe概念" class="headerlink" title="subscribe概念"></a>subscribe概念</h2><ul>
<li>订阅有发布间隔。订阅的发布间隔定义了订阅的循环执行速度。每次执行时，它都会尝试向客户端发送一条通知消息（NotificationMessage）。通知消息包含尚未报告给客户端的通知</li>
<li>通知信息（NotificationMessage）是对发布请求的响应，会被发送到客户端。发布请求通常会在收到时排队到会话中，如果有通知要报告，则会在每个发布周期将其中一个发布请求取消排队并由与该会话相关的订阅处理。如果没有，发布请求不会从会话中解除排队，服务器会等到下一个周期再检查是否有通知。</li>
<li>在一个周期开始时，如果有通知要发送，但没有发布请求排队，服务器就会进入等待状态，等待收到发布请求。当收到发布请求时，会立即进行处理，而无需等待下一个发布周期。</li>
<li>通知消息（NotificationMessage）通过序列号进行唯一标识，以便客户端检测遗漏的消息。发布间隔还定义了其监控项目的默认采样间隔。</li>
<li>订阅有一个保持连接计数器，用于计算没有通知报告给客户端的连续发布周期数。当达到最大 keep-alive 计数时，发布请求将被取消排队，并返回一条 keep-alive 消息。该 keep-alive Message 通知客户机订阅仍处于活动状态。每个保持消息都是对 “发布 ”请求的响应，其中的 notificationMessage 参数不包含任何通知，并包含要发送的下一个 NotificationMessage 的序列号。在后面的条款中，术语 “通知信息 ”指的是对发布请求的响应，其中的 notificationMessage 参数实际上包含一个或多个通知，而不是 keep-alive 信息，在 keep-alive 信息中该参数不包含任何通知。最大保持连接次数由客户机在创建订阅时设定，随后可使用 ModifySubscription 服务进行修改。与上文(c)所述的通知处理类似，如果没有发布请求排队，服务器将等待接收下一个发布请求，并立即发送 keep-alive，而无需等待下一个发布周期。</li>
<li>客户端可在创建订阅时启用或禁用订阅的发布功能，也可随后使用 SetPublishingMode 服务启用或禁用订阅的发布功能。禁用会导致订阅号停止向客户端发送通知消息。不过，订阅会继续循环执行，并继续向客户端发送 “保持更新信息”。</li>
<li>订阅有一个生命周期计数器，用于计算没有可用的发布请求为订阅发送发布响应的连续发布周期数。任何使用 SubscriptionId 的服务调用或对发布响应的处理都会重置该订阅的生命周期计数器。当该计数器达到为订阅的生命周期计算的值时，订阅将被关闭。关闭订阅会导致其监控项目被删除。此外，服务器还将发出状态代码为 Bad_Timeout 的 StatusChangeNotification 通知消息。StatusChangeNotification 通知消息类型在 7.25.4 中定义。</li>
<li>会话维护一个已发送通知消息的重传队列。通知信息将保留在该队列中，直至得到确认。会话维护的重传队列大小至少是服务器支持的每个会话发布请求数的两倍。OPC 10000-7 中的配置文件可以使重传队列支持成为可选项。服务器应支持的每个会话的最小发布请求数在 OPC 10000-7 中定义。如果 “发布 ”响应参数 availableSequenceNumbers（可用序列号）不是空数组，则客户端必须在收到 “通知消息 ”时予以确认。如果 availableSequenceNumbers 中的数组为空，则表示服务器不支持重传队列和对通知信息的确认。在重传队列溢出的情况下，最早发送的通知信息会被删除。如果订阅被转移到另一个会话，该订阅的队列通知信息将从旧会话转移到新会话。</li>
</ul>
<h2 id="subscription创建流程："><a href="#subscription创建流程：" class="headerlink" title="subscription创建流程："></a>subscription创建流程：</h2><h3 id="Service-CreateSubscription-创建一个订阅"><a href="#Service-CreateSubscription-创建一个订阅" class="headerlink" title="Service_CreateSubscription 创建一个订阅"></a>Service_CreateSubscription 创建一个订阅</h3><ul>
<li>该服务用于创建订阅。订阅会监控一组 MonitoredItems 以获取通知，并根据发布请求将其返回给客户端。</li>
<li>open62541实现：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">UA_CreateSubscriptionResponse</span><br><span class="line"><span class="title function_">UA_Client_Subscriptions_create</span><span class="params">(UA_Client *client,</span></span><br><span class="line"><span class="params">                            <span class="type">const</span> UA_CreateSubscriptionRequest request,</span></span><br><span class="line"><span class="params">                            <span class="type">void</span> *subscriptionContext,</span></span><br><span class="line"><span class="params">                            UA_Client_StatusChangeNotificationCallback statusChangeCallback,</span></span><br><span class="line"><span class="params">                            UA_Client_DeleteSubscriptionCallback deleteCallback)</span> &#123;</span><br><span class="line">    UA_CreateSubscriptionResponse response;</span><br><span class="line">    UA_Client_Subscription *sub = (UA_Client_Subscription *)</span><br><span class="line">        UA_malloc(<span class="keyword">sizeof</span>(UA_Client_Subscription));</span><br><span class="line">    <span class="keyword">if</span>(!sub) &#123;</span><br><span class="line">        UA_CreateSubscriptionResponse_init(&amp;response);</span><br><span class="line">        response.responseHeader.serviceResult = UA_STATUSCODE_BADOUTOFMEMORY;</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line">    sub-&gt;context = subscriptionContext;</span><br><span class="line">    sub-&gt;statusChangeCallback = statusChangeCallback;</span><br><span class="line">    sub-&gt;deleteCallback = deleteCallback;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Send the request as a synchronous service call */</span></span><br><span class="line">    __UA_Client_Service(client,</span><br><span class="line">                        &amp;request, &amp;UA_TYPES[UA_TYPES_CREATESUBSCRIPTIONREQUEST],</span><br><span class="line">                        &amp;response, &amp;UA_TYPES[UA_TYPES_CREATESUBSCRIPTIONRESPONSE]);</span><br><span class="line">    <span class="keyword">if</span> (response.responseHeader.serviceResult != UA_STATUSCODE_GOOD) &#123;</span><br><span class="line">        UA_free (sub);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UA_LOCK(&amp;client-&gt;clientMutex);</span><br><span class="line">    ua_Subscriptions_create(client, sub, &amp;response);</span><br><span class="line">    UA_UNLOCK(&amp;client-&gt;clientMutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">ua_Subscriptions_create</span><span class="params">(UA_Client *client, UA_Client_Subscription *newSub,</span></span><br><span class="line"><span class="params">                        UA_CreateSubscriptionResponse *response)</span> &#123;</span><br><span class="line">    UA_LOCK_ASSERT(&amp;client-&gt;clientMutex, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    newSub-&gt;subscriptionId = response-&gt;subscriptionId;</span><br><span class="line">    newSub-&gt;sequenceNumber = <span class="number">0</span>;</span><br><span class="line">    newSub-&gt;lastActivity = UA_DateTime_nowMonotonic();</span><br><span class="line">    newSub-&gt;publishingInterval = response-&gt;revisedPublishingInterval;</span><br><span class="line">    newSub-&gt;maxKeepAliveCount = response-&gt;revisedMaxKeepAliveCount;</span><br><span class="line">    ZIP_INIT(&amp;newSub-&gt;monitoredItems);</span><br><span class="line">    LIST_INSERT_HEAD(&amp;client-&gt;subscriptions, newSub, listEntry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Immediately send the first publish requests if there are none</span></span><br><span class="line"><span class="comment">    * outstanding */</span></span><br><span class="line">    __Client_Subscriptions_backgroundPublish(client);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>创建流程解析：<ol>
<li>初始化：subscription内的成员变量：一些成员变量根据request中的值来确认  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/* Subscriptions are managed in a server-wide linked list. If they are attached</span></span><br><span class="line"><span class="comment">* to a Session, then they are additionaly in the per-Session linked-list. A</span></span><br><span class="line"><span class="comment">* subscription is always generated for a Session. But the CloseSession Service</span></span><br><span class="line"><span class="comment">* may keep Subscriptions intact beyond the Session lifetime. They can then be</span></span><br><span class="line"><span class="comment">* re-bound to a new Session with the TransferSubscription Service. */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">UA_Subscription</span> &#123;</span></span><br><span class="line">     UA_DelayedCallback delayedFreePointers;</span><br><span class="line">     LIST_ENTRY(UA_Subscription) serverListEntry;</span><br><span class="line">     <span class="comment">/* Ordered according to the priority byte and round-robin scheduling for</span></span><br><span class="line"><span class="comment">     * late subscriptions. See ua_session.h. Only set if session != NULL. */</span></span><br><span class="line">     TAILQ_ENTRY(UA_Subscription) sessionListEntry;</span><br><span class="line">     UA_Session *session; <span class="comment">/* May be NULL if no session is attached. */</span></span><br><span class="line">     UA_UInt32 subscriptionId;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Settings */</span></span><br><span class="line">     UA_UInt32 lifeTimeCount;</span><br><span class="line">     UA_UInt32 maxKeepAliveCount;</span><br><span class="line">     UA_Double publishingInterval; <span class="comment">/* in ms */</span></span><br><span class="line">     UA_UInt32 notificationsPerPublish;</span><br><span class="line">     UA_Byte priority;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Runtime information */</span></span><br><span class="line">     UA_SubscriptionState state;</span><br><span class="line">     UA_Boolean late;</span><br><span class="line">     UA_StatusCode statusChange; <span class="comment">/* If set, a notification is generated and the</span></span><br><span class="line"><span class="comment">                                 * Subscription is deleted within</span></span><br><span class="line"><span class="comment">                                 * UA_Subscription_publish. */</span></span><br><span class="line">     UA_UInt32 nextSequenceNumber;</span><br><span class="line">     UA_UInt32 currentKeepAliveCount;</span><br><span class="line">     UA_UInt32 currentLifetimeCount;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Publish Callback. Registered if id &gt; 0. */</span></span><br><span class="line">     UA_UInt64 publishCallbackId;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Delayed callback to schedule publication of more notifications */</span></span><br><span class="line">     UA_Boolean delayedCallbackRegistered;</span><br><span class="line">     UA_DelayedCallback delayedMoreNotifications;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* MonitoredItems */</span></span><br><span class="line">     UA_UInt32 lastMonitoredItemId; <span class="comment">/* increase the identifiers */</span></span><br><span class="line">     LIST_HEAD(, UA_MonitoredItem) monitoredItems;</span><br><span class="line">     UA_UInt32 monitoredItemsSize;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* MonitoredItems that are sampled in every publish callback (with the</span></span><br><span class="line"><span class="comment">     * publish interval of the subscription) */</span></span><br><span class="line">     LIST_HEAD(, UA_MonitoredItem) samplingMonitoredItems;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Global list of notifications from the MonitoredItems */</span></span><br><span class="line">     TAILQ_HEAD(, UA_Notification) notificationQueue;</span><br><span class="line">     UA_UInt32 notificationQueueSize; <span class="comment">/* Total queue size */</span></span><br><span class="line">     UA_UInt32 dataChangeNotifications;</span><br><span class="line">     UA_UInt32 eventNotifications;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Retransmission Queue */</span></span><br><span class="line">     NotificationMessageQueue retransmissionQueue;</span><br><span class="line">     <span class="type">size_t</span> retransmissionQueueSize;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Statistics for the server diagnostics. The fields are defined according</span></span><br><span class="line"><span class="comment">     * to the SubscriptionDiagnosticsDataType (Part 5, §12.15). */</span></span><br><span class="line">     <span class="meta">#<span class="keyword">ifdef</span> UA_ENABLE_DIAGNOSTICS</span></span><br><span class="line">         UA_NodeId ns0Id; <span class="comment">/* Representation in the Session object */</span></span><br><span class="line"></span><br><span class="line">         UA_UInt32 modifyCount;</span><br><span class="line">         UA_UInt32 enableCount;</span><br><span class="line">         UA_UInt32 disableCount;</span><br><span class="line">         UA_UInt32 republishRequestCount;</span><br><span class="line">         UA_UInt32 republishMessageCount;</span><br><span class="line">         UA_UInt32 transferRequestCount;</span><br><span class="line">         UA_UInt32 transferredToAltClientCount;</span><br><span class="line">         UA_UInt32 transferredToSameClientCount;</span><br><span class="line">         UA_UInt32 publishRequestCount;</span><br><span class="line">         UA_UInt32 dataChangeNotificationsCount;</span><br><span class="line">         UA_UInt32 eventNotificationsCount;</span><br><span class="line">         UA_UInt32 notificationsCount;</span><br><span class="line">         UA_UInt32 latePublishRequestCount;</span><br><span class="line">         UA_UInt32 discardedMessageCount;</span><br><span class="line">         UA_UInt32 monitoringQueueOverflowCount;</span><br><span class="line">         UA_UInt32 eventQueueOverFlowCount;</span><br><span class="line">     <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>注册sub到server，更新server上的相关计数  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 把新创建的sub插入到server的subList头部</span></span><br><span class="line"><span class="comment">// 这里这个插入函数比较特别，第三个参数是sub中前后指针，这使得可以维护一个复杂的多连接结构</span></span><br><span class="line">LIST_INSERT_HEAD(&amp;server-&gt;subscriptions, sub, serverListEntry);</span><br><span class="line">server-&gt;subscriptionsSize++;</span><br></pre></td></tr></table></figure></li>
<li>添加sub到session，增加数目，重传队列大小，按优先级插入session的队列   <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">UA_Session_attachSubscription</span><span class="params">(UA_Session *session, UA_Subscription *sub)</span> &#123;</span><br><span class="line">    <span class="comment">/* Attach to the session */</span></span><br><span class="line">    sub-&gt;session = session;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Increase the count */</span></span><br><span class="line">    session-&gt;subscriptionsSize++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Increase the number of outstanding retransmissions */</span></span><br><span class="line">    session-&gt;totalRetransmissionQueueSize += sub-&gt;retransmissionQueueSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Insert at the end of the subscriptions of the same priority / just before</span></span><br><span class="line"><span class="comment">    * the subscriptions with the next lower priority. */</span></span><br><span class="line">    UA_Subscription *after = <span class="literal">NULL</span>;</span><br><span class="line">    TAILQ_FOREACH(after, &amp;session-&gt;subscriptions, sessionListEntry) &#123;</span><br><span class="line">        <span class="keyword">if</span>(after-&gt;priority &lt; sub-&gt;priority) &#123;</span><br><span class="line">            TAILQ_INSERT_BEFORE(after, sub, sessionListEntry);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    TAILQ_INSERT_TAIL(&amp;session-&gt;subscriptions, sub, sessionListEntry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>如果开启了诊断宏开关，就设置</li>
<li>设置response并返回</li>
</ol>
</li>
</ul>
<h3 id="Service-Publish-发布订阅消息"><a href="#Service-Publish-发布订阅消息" class="headerlink" title="Service_Publish 发布订阅消息"></a>Service_Publish 发布订阅消息</h3><ul>
<li>monitor的值变化后形成一个message放在服务端的堆积队列中，客户端回轮询服务端，服务端之后返回response传递值。客户端接受到消息之后，在下一条publish请求中发送确认队列，同时服务端丢弃已经被确认的消息。可能有多个订阅，要通过算法选择最终回复那个订阅</li>
<li>open62541实现<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">UA_StatusCode</span><br><span class="line"><span class="title function_">Service_Publish</span><span class="params">(UA_Server *server, UA_Session *session,</span></span><br><span class="line"><span class="params">                <span class="type">const</span> UA_PublishRequest *request, UA_UInt32 requestId)</span> &#123;</span><br><span class="line">    UA_LOG_DEBUG_SESSION(server-&gt;config.logging, session,</span><br><span class="line">                        <span class="string">&quot;Processing PublishRequest with RequestId %u&quot;</span>, requestId);</span><br><span class="line">    UA_LOCK_ASSERT(&amp;server-&gt;serviceMutex, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return an error if the session has no subscription */</span></span><br><span class="line">    <span class="keyword">if</span>(TAILQ_EMPTY(&amp;session-&gt;subscriptions)) &#123;</span><br><span class="line">        sendServiceFault(session-&gt;header.channel, requestId,</span><br><span class="line">                        request-&gt;requestHeader.requestHandle,</span><br><span class="line">                        UA_STATUSCODE_BADNOSUBSCRIPTION);</span><br><span class="line">        <span class="keyword">return</span> UA_STATUSCODE_BADNOSUBSCRIPTION;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Handle too many subscriptions to free resources before trying to allocate</span></span><br><span class="line"><span class="comment">    * resources for the new publish request. If the limit has been reached the</span></span><br><span class="line"><span class="comment">    * oldest publish request are returned with an error message. */</span></span><br><span class="line">    UA_Session_ensurePublishQueueSpace(server, session);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate the response to store it in the retransmission queue */</span></span><br><span class="line">    UA_PublishResponseEntry *entry = (UA_PublishResponseEntry *)</span><br><span class="line">        UA_malloc(<span class="keyword">sizeof</span>(UA_PublishResponseEntry));</span><br><span class="line">    <span class="keyword">if</span>(!entry) &#123;</span><br><span class="line">        sendServiceFault(session-&gt;header.channel, requestId,</span><br><span class="line">                        request-&gt;requestHeader.requestHandle,</span><br><span class="line">                        UA_STATUSCODE_BADOUTOFMEMORY);</span><br><span class="line">        <span class="keyword">return</span> UA_STATUSCODE_BADOUTOFMEMORY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Prepare the response */</span></span><br><span class="line">    entry-&gt;requestId = requestId;</span><br><span class="line">    UA_PublishResponse *response = &amp;entry-&gt;response;</span><br><span class="line">    UA_PublishResponse_init(response);</span><br><span class="line">    response-&gt;responseHeader.requestHandle = request-&gt;requestHeader.requestHandle;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate the results array to acknowledge the acknowledge */</span></span><br><span class="line">    <span class="keyword">if</span>(request-&gt;subscriptionAcknowledgementsSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        response-&gt;results = (UA_StatusCode *)</span><br><span class="line">            UA_Array_new(request-&gt;subscriptionAcknowledgementsSize,</span><br><span class="line">                        &amp;UA_TYPES[UA_TYPES_STATUSCODE]);</span><br><span class="line">        <span class="keyword">if</span>(!response-&gt;results) &#123;</span><br><span class="line">            UA_free(entry);</span><br><span class="line">            sendServiceFault(session-&gt;header.channel, requestId,</span><br><span class="line">                            request-&gt;requestHeader.requestHandle,</span><br><span class="line">                            UA_STATUSCODE_BADOUTOFMEMORY);</span><br><span class="line">            <span class="keyword">return</span> UA_STATUSCODE_BADOUTOFMEMORY;</span><br><span class="line">        &#125;</span><br><span class="line">        response-&gt;resultsSize = request-&gt;subscriptionAcknowledgementsSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* &lt;--- A good StatusCode is returned from here on ---&gt; */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Delete Acknowledged Subscription Messages */</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; request-&gt;subscriptionAcknowledgementsSize; ++i) &#123;</span><br><span class="line">        UA_SubscriptionAcknowledgement *ack = &amp;request-&gt;subscriptionAcknowledgements[i];</span><br><span class="line">        UA_Subscription *sub = UA_Session_getSubscriptionById(session, ack-&gt;subscriptionId);</span><br><span class="line">        <span class="keyword">if</span>(!sub) &#123;</span><br><span class="line">            response-&gt;results[i] = UA_STATUSCODE_BADSUBSCRIPTIONIDINVALID;</span><br><span class="line">            UA_LOG_DEBUG_SESSION(server-&gt;config.logging, session,</span><br><span class="line">                                <span class="string">&quot;Cannot process acknowledgements subscription %u&quot;</span> PRIu32,</span><br><span class="line">                                ack-&gt;subscriptionId);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Remove the acked transmission from the retransmission queue */</span></span><br><span class="line">        response-&gt;results[i] =</span><br><span class="line">            UA_Subscription_removeRetransmissionMessage(sub, ack-&gt;sequenceNumber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the maxTime if a timeout hint is defined */</span></span><br><span class="line">    entry-&gt;maxTime = UA_INT64_MAX;</span><br><span class="line">    <span class="keyword">if</span>(request-&gt;requestHeader.timeoutHint &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        UA_EventLoop *el = server-&gt;config.eventLoop;</span><br><span class="line">        entry-&gt;maxTime = el-&gt;dateTime_nowMonotonic(el) +</span><br><span class="line">            (request-&gt;requestHeader.timeoutHint * UA_DATETIME_MSEC);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Queue the publish response. It will be dequeued in a repeated publish</span></span><br><span class="line"><span class="comment">    * callback. This can also be triggered right now for a late</span></span><br><span class="line"><span class="comment">    * subscription. */</span></span><br><span class="line">    UA_Session_queuePublishReq(session, entry, <span class="literal">false</span>);</span><br><span class="line">    UA_LOG_DEBUG_SESSION(server-&gt;config.logging, session, <span class="string">&quot;Queued a publication message&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If there are late subscriptions, the new publish request is used to</span></span><br><span class="line"><span class="comment">    * answer them immediately. Late subscriptions with higher priority are</span></span><br><span class="line"><span class="comment">    * considered earlier. However, a single subscription that generates many</span></span><br><span class="line"><span class="comment">    * notifications must not &quot;starve&quot; other late subscriptions. Hence we move</span></span><br><span class="line"><span class="comment">    * it to the end of the queue for the subscriptions of that priority. */</span></span><br><span class="line">    UA_Subscription *late, *late_tmp;</span><br><span class="line">    TAILQ_FOREACH_SAFE(late, &amp;session-&gt;subscriptions, sessionListEntry, late_tmp) &#123;</span><br><span class="line">        <span class="comment">/* Skip non-late subscriptions */</span></span><br><span class="line">        <span class="keyword">if</span>(!late-&gt;late)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Call publish on the late subscription */</span></span><br><span class="line">        UA_LOG_DEBUG_SUBSCRIPTION(server-&gt;config.logging, late,</span><br><span class="line">                                <span class="string">&quot;Send PublishResponse on a late subscription&quot;</span>);</span><br><span class="line">        UA_Subscription_publish(server, late);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Skip re-insert if the subscription was deleted or deactivated during</span></span><br><span class="line"><span class="comment">        * _publish */</span></span><br><span class="line">        <span class="keyword">if</span>(late-&gt;state &gt;= UA_SUBSCRIPTIONSTATE_ENABLED_NOPUBLISH) &#123;</span><br><span class="line">            <span class="comment">/* Find the first element with smaller priority and insert before</span></span><br><span class="line"><span class="comment">            * that. If there is none, insert at the end of the queue. */</span></span><br><span class="line">            UA_Subscription *after = TAILQ_NEXT(late, sessionListEntry);</span><br><span class="line">            <span class="keyword">while</span>(after &amp;&amp; after-&gt;priority &gt;= late-&gt;priority)</span><br><span class="line">                after = TAILQ_NEXT(after, sessionListEntry);</span><br><span class="line">            TAILQ_REMOVE(&amp;session-&gt;subscriptions, late, sessionListEntry);</span><br><span class="line">            <span class="keyword">if</span>(after)</span><br><span class="line">                TAILQ_INSERT_BEFORE(after, late, sessionListEntry);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                TAILQ_INSERT_TAIL(&amp;session-&gt;subscriptions, late, sessionListEntry);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Responses left in the queue? */</span></span><br><span class="line">        <span class="keyword">if</span>(session-&gt;responseQueueSize == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> UA_STATUSCODE_GOOD;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Try to publish now. Enqueue a &quot;next publish&quot; as a delayed callback if not</span></span><br><span class="line"><span class="comment">* done. */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">UA_Subscription_publish</span><span class="params">(UA_Server *server, UA_Subscription *sub)</span> &#123;</span><br><span class="line">    <span class="comment">/* Get a response */</span></span><br><span class="line">    UA_PublishResponseEntry *pre = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>(sub-&gt;session) &#123;</span><br><span class="line">        UA_EventLoop *el = server-&gt;config.eventLoop;</span><br><span class="line">        UA_DateTime nowMonotonic = el-&gt;dateTime_nowMonotonic(el);</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">/* Dequeue the oldest response */</span></span><br><span class="line">            pre = UA_Session_dequeuePublishReq(sub-&gt;session);</span><br><span class="line">            <span class="keyword">if</span>(!pre)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Check if the TimeoutHint is still valid. Otherwise return with a bad</span></span><br><span class="line"><span class="comment">            * statuscode and continue. */</span></span><br><span class="line">            <span class="keyword">if</span>(pre-&gt;maxTime &lt; nowMonotonic) &#123;</span><br><span class="line">                UA_LOG_DEBUG_SESSION(server-&gt;config.logging, sub-&gt;session,</span><br><span class="line">                                    <span class="string">&quot;Publish request %u has timed out&quot;</span>, pre-&gt;requestId);</span><br><span class="line">                pre-&gt;response.responseHeader.serviceResult = UA_STATUSCODE_BADTIMEOUT;</span><br><span class="line">                sendResponse(server, sub-&gt;session, sub-&gt;session-&gt;header.channel,</span><br><span class="line">                            pre-&gt;requestId, (UA_Response *)&amp;pre-&gt;response,</span><br><span class="line">                            &amp;UA_TYPES[UA_TYPES_PUBLISHRESPONSE]);</span><br><span class="line">                UA_PublishResponse_clear(&amp;pre-&gt;response);</span><br><span class="line">                UA_free(pre);</span><br><span class="line">                pre = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span>(!pre);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Update the LifetimeCounter */</span></span><br><span class="line">    <span class="keyword">if</span>(pre) &#123;</span><br><span class="line">        Subscription_resetLifetime(sub);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        UA_LOG_DEBUG_SUBSCRIPTION(server-&gt;config.logging, sub,</span><br><span class="line">                                <span class="string">&quot;The publish queue is empty&quot;</span>);</span><br><span class="line">        ++sub-&gt;currentLifetimeCount;</span><br><span class="line">        <span class="keyword">if</span>(sub-&gt;currentLifetimeCount &gt; sub-&gt;lifeTimeCount) &#123;</span><br><span class="line">            UA_LOG_WARNING_SUBSCRIPTION(server-&gt;config.logging, sub,</span><br><span class="line">                                        <span class="string">&quot;End of subscription lifetime&quot;</span>);</span><br><span class="line">            <span class="comment">/* Set the StatusChange to delete the subscription. */</span></span><br><span class="line">            sub-&gt;statusChange = UA_STATUSCODE_BADTIMEOUT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Send a StatusChange notification if possible and delete the</span></span><br><span class="line"><span class="comment">    * Subscription */</span></span><br><span class="line">    <span class="keyword">if</span>(sub-&gt;statusChange != UA_STATUSCODE_GOOD) &#123;</span><br><span class="line">        sendStatusChangeDelete(server, sub, pre);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Dsiabled subscriptions do not send notifications */</span></span><br><span class="line">    UA_UInt32 notifications = (sub-&gt;state == UA_SUBSCRIPTIONSTATE_ENABLED) ?</span><br><span class="line">        sub-&gt;notificationQueueSize : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Limit the number of notifications to the configured maximum */</span></span><br><span class="line">    <span class="keyword">if</span>(notifications &gt; sub-&gt;notificationsPerPublish)</span><br><span class="line">        notifications = sub-&gt;notificationsPerPublish;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return if no notifications and no keepalive */</span></span><br><span class="line">    <span class="keyword">if</span>(notifications == <span class="number">0</span>) &#123;</span><br><span class="line">        ++sub-&gt;currentKeepAliveCount;</span><br><span class="line">        <span class="keyword">if</span>(sub-&gt;currentKeepAliveCount &lt; sub-&gt;maxKeepAliveCount) &#123;</span><br><span class="line">            <span class="keyword">if</span>(pre)</span><br><span class="line">                UA_Session_queuePublishReq(sub-&gt;session, pre, <span class="literal">true</span>); <span class="comment">/* Re-enqueue */</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        UA_LOG_DEBUG_SUBSCRIPTION(server-&gt;config.logging, sub, <span class="string">&quot;Sending a KeepAlive&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We want to send a response, but cannot. Either because there is no queued</span></span><br><span class="line"><span class="comment">    * response or because the Subscription is detached from a Session or because</span></span><br><span class="line"><span class="comment">    * the SecureChannel for the Session is closed. */</span></span><br><span class="line">    <span class="keyword">if</span>(!pre || !sub-&gt;session || !sub-&gt;session-&gt;header.channel) &#123;</span><br><span class="line">        UA_LOG_DEBUG_SUBSCRIPTION(server-&gt;config.logging, sub,</span><br><span class="line">                                <span class="string">&quot;Want to send a publish response but cannot. &quot;</span></span><br><span class="line">                                <span class="string">&quot;The subscription is late.&quot;</span>);</span><br><span class="line">        sub-&gt;late = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">if</span>(pre)</span><br><span class="line">            UA_Session_queuePublishReq(sub-&gt;session, pre, <span class="literal">true</span>); <span class="comment">/* Re-enqueue */</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UA_assert(pre);</span><br><span class="line">    UA_assert(sub-&gt;session); <span class="comment">/* Otherwise pre is NULL */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Prepare the response */</span></span><br><span class="line">    UA_PublishResponse *response = &amp;pre-&gt;response;</span><br><span class="line">    UA_NotificationMessage *message = &amp;response-&gt;notificationMessage;</span><br><span class="line">    UA_NotificationMessageEntry *retransmission = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> UA_ENABLE_DIAGNOSTICS</span></span><br><span class="line">    <span class="type">size_t</span> priorDataChangeNotifications = sub-&gt;dataChangeNotifications;</span><br><span class="line">    <span class="type">size_t</span> priorEventNotifications = sub-&gt;eventNotifications;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span>(notifications &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(server-&gt;config.enableRetransmissionQueue) &#123;</span><br><span class="line">            <span class="comment">/* Allocate the retransmission entry */</span></span><br><span class="line">            retransmission = (UA_NotificationMessageEntry*)</span><br><span class="line">                UA_malloc(<span class="keyword">sizeof</span>(UA_NotificationMessageEntry));</span><br><span class="line">            <span class="keyword">if</span>(!retransmission) &#123;</span><br><span class="line">                UA_LOG_WARNING_SUBSCRIPTION(server-&gt;config.logging, sub,</span><br><span class="line">                                            <span class="string">&quot;Could not allocate memory for retransmission. &quot;</span></span><br><span class="line">                                            <span class="string">&quot;The subscription is late.&quot;</span>);</span><br><span class="line">                sub-&gt;late = <span class="literal">true</span>;</span><br><span class="line">                UA_Session_queuePublishReq(sub-&gt;session, pre, <span class="literal">true</span>); <span class="comment">/* Re-enqueue */</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Prepare the response */</span></span><br><span class="line">        UA_StatusCode retval =</span><br><span class="line">            prepareNotificationMessage(server, sub, message, notifications);</span><br><span class="line">        <span class="keyword">if</span>(retval != UA_STATUSCODE_GOOD) &#123;</span><br><span class="line">            UA_LOG_WARNING_SUBSCRIPTION(server-&gt;config.logging, sub,</span><br><span class="line">                                        <span class="string">&quot;Could not prepare the notification message. &quot;</span></span><br><span class="line">                                        <span class="string">&quot;The subscription is late.&quot;</span>);</span><br><span class="line">            <span class="comment">/* If the retransmission queue is enabled a retransmission message is allocated */</span></span><br><span class="line">            <span class="keyword">if</span>(retransmission)</span><br><span class="line">                UA_free(retransmission);</span><br><span class="line">            sub-&gt;late = <span class="literal">true</span>;</span><br><span class="line">            UA_Session_queuePublishReq(sub-&gt;session, pre, <span class="literal">true</span>); <span class="comment">/* Re-enqueue */</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* &lt;-- The point of no return --&gt; */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set up the response */</span></span><br><span class="line">    response-&gt;subscriptionId = sub-&gt;subscriptionId;</span><br><span class="line">    response-&gt;moreNotifications = (sub-&gt;notificationQueueSize &gt; <span class="number">0</span>);</span><br><span class="line">    message-&gt;publishTime = UA_DateTime_now();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set sequence number to message. Started at 1 which is given during</span></span><br><span class="line"><span class="comment">    * creating a new subscription. The 1 is required for initial publish</span></span><br><span class="line"><span class="comment">    * response with or without an monitored item. */</span></span><br><span class="line">    message-&gt;sequenceNumber = sub-&gt;nextSequenceNumber;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(notifications &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* If the retransmission queue is enabled a retransmission message is</span></span><br><span class="line"><span class="comment">        * allocated */</span></span><br><span class="line">        <span class="keyword">if</span>(retransmission) &#123;</span><br><span class="line">            <span class="comment">/* Put the notification message into the retransmission queue. This</span></span><br><span class="line"><span class="comment">            * needs to be done here, so that the message itself is included in</span></span><br><span class="line"><span class="comment">            * the available sequence numbers for acknowledgement. */</span></span><br><span class="line">            retransmission-&gt;message = response-&gt;notificationMessage;</span><br><span class="line">            UA_Subscription_addRetransmissionMessage(server, sub, retransmission);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* Only if a notification was created, the sequence number must be</span></span><br><span class="line"><span class="comment">        * increased. For a keepalive the sequence number can be reused. */</span></span><br><span class="line">        sub-&gt;nextSequenceNumber =</span><br><span class="line">            UA_Subscription_nextSequenceNumber(sub-&gt;nextSequenceNumber);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get the available sequence numbers from the retransmission queue */</span></span><br><span class="line">    UA_assert(sub-&gt;retransmissionQueueSize &lt;= UA_MAX_RETRANSMISSIONQUEUESIZE);</span><br><span class="line">    UA_UInt32 seqNumbers[UA_MAX_RETRANSMISSIONQUEUESIZE];</span><br><span class="line">    response-&gt;availableSequenceNumbers = seqNumbers;</span><br><span class="line">    response-&gt;availableSequenceNumbersSize = sub-&gt;retransmissionQueueSize;</span><br><span class="line">    <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">    UA_NotificationMessageEntry *nme;</span><br><span class="line">    TAILQ_FOREACH(nme, &amp;sub-&gt;retransmissionQueue, listEntry) &#123;</span><br><span class="line">        response-&gt;availableSequenceNumbers[i] = nme-&gt;message.sequenceNumber;</span><br><span class="line">        ++i;</span><br><span class="line">    &#125;</span><br><span class="line">    UA_assert(i == sub-&gt;retransmissionQueueSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Send the response */</span></span><br><span class="line">    UA_LOG_DEBUG_SUBSCRIPTION(server-&gt;config.logging, sub,</span><br><span class="line">                            <span class="string">&quot;Sending out a publish response with %&quot;</span> PRIu32</span><br><span class="line">                            <span class="string">&quot; notifications&quot;</span>, notifications);</span><br><span class="line">    sendResponse(server, sub-&gt;session, sub-&gt;session-&gt;header.channel, pre-&gt;requestId,</span><br><span class="line">                (UA_Response*)response, &amp;UA_TYPES[UA_TYPES_PUBLISHRESPONSE]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Reset the Subscription state to NORMAL. But only if all notifications</span></span><br><span class="line"><span class="comment">    * have been sent out. Otherwise keep the Subscription in the LATE state. So</span></span><br><span class="line"><span class="comment">    * we immediately answer incoming Publish requests.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * (We also check that session-&gt;responseQueueSize &gt; 0 in Service_Publish. To</span></span><br><span class="line"><span class="comment">    * avoid answering Publish requests out of order. As we additionally may have</span></span><br><span class="line"><span class="comment">    * scheduled a publish callback as a delayed callback. */</span></span><br><span class="line">    <span class="keyword">if</span>(sub-&gt;notificationQueueSize == <span class="number">0</span>)</span><br><span class="line">        sub-&gt;late = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Reset the KeepAlive after publishing */</span></span><br><span class="line">    sub-&gt;currentKeepAliveCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Free the response */</span></span><br><span class="line">    <span class="keyword">if</span>(retransmission) &#123;</span><br><span class="line">        <span class="comment">/* NotificationMessage was moved into retransmission queue */</span></span><br><span class="line">        UA_NotificationMessage_init(&amp;response-&gt;notificationMessage);</span><br><span class="line">    &#125;</span><br><span class="line">    response-&gt;availableSequenceNumbers = <span class="literal">NULL</span>;</span><br><span class="line">    response-&gt;availableSequenceNumbersSize = <span class="number">0</span>;</span><br><span class="line">    UA_PublishResponse_clear(&amp;pre-&gt;response);</span><br><span class="line">    UA_free(pre);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Update the diagnostics statistics */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> UA_ENABLE_DIAGNOSTICS</span></span><br><span class="line">    sub-&gt;publishRequestCount++;</span><br><span class="line"></span><br><span class="line">    UA_UInt32 sentDCN = (UA_UInt32)</span><br><span class="line">        (priorDataChangeNotifications - sub-&gt;dataChangeNotifications);</span><br><span class="line">    UA_UInt32 sentEN = (UA_UInt32)(priorEventNotifications - sub-&gt;eventNotifications);</span><br><span class="line">    sub-&gt;dataChangeNotificationsCount += sentDCN;</span><br><span class="line">    sub-&gt;eventNotificationsCount += sentEN;</span><br><span class="line">    sub-&gt;notificationsCount += (sentDCN + sentEN);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Repeat sending notifications if there are more notifications to send. But</span></span><br><span class="line"><span class="comment">    * only call monitoredItem_sampleCallback in the regular publish</span></span><br><span class="line"><span class="comment">    * callback. */</span></span><br><span class="line">    UA_Boolean done = (sub-&gt;notificationQueueSize == <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(!done &amp;&amp; !sub-&gt;delayedCallbackRegistered) &#123;</span><br><span class="line">        sub-&gt;delayedCallbackRegistered = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        sub-&gt;delayedMoreNotifications.callback = (UA_Callback)delayedPublishNotifications;</span><br><span class="line">        sub-&gt;delayedMoreNotifications.application = server;</span><br><span class="line">        sub-&gt;delayedMoreNotifications.context = sub;</span><br><span class="line"></span><br><span class="line">        UA_EventLoop *el = server-&gt;config.eventLoop;</span><br><span class="line">        el-&gt;addDelayedCallback(el, &amp;sub-&gt;delayedMoreNotifications);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="monitor概念"><a href="#monitor概念" class="headerlink" title="monitor概念"></a>monitor概念</h2><p>服务器中由客户定义的实体，用于监控属性或事件提示器的新值或事件发生情况，并为其生成通知（Notification）。通知会被送入订阅的堆积队列中等待publish</p>
<h3 id="monitor如何监视变化？"><a href="#monitor如何监视变化？" class="headerlink" title="monitor如何监视变化？"></a>monitor如何监视变化？</h3><h4 id="UA-Client-MonitoredItems-createDataChanges"><a href="#UA-Client-MonitoredItems-createDataChanges" class="headerlink" title="UA_Client_MonitoredItems_createDataChanges"></a>UA_Client_MonitoredItems_createDataChanges</h4><ul>
<li><p>入口是这里，callbacks就是收到监控数据变化后客户端的反应</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">UA_CreateMonitoredItemsResponse</span><br><span class="line"><span class="title function_">UA_Client_MonitoredItems_createDataChanges</span><span class="params">(UA_Client *client,</span></span><br><span class="line"><span class="params">                                        <span class="type">const</span> UA_CreateMonitoredItemsRequest request,</span></span><br><span class="line"><span class="params">                                        <span class="type">void</span> **contexts,</span></span><br><span class="line"><span class="params">                                        UA_Client_DataChangeNotificationCallback *callbacks,</span></span><br><span class="line"><span class="params">                                        UA_Client_DeleteMonitoredItemCallback *deleteCallbacks)</span> &#123;</span><br><span class="line">    UA_CreateMonitoredItemsResponse response;</span><br><span class="line">    UA_LOCK(&amp;client-&gt;clientMutex);</span><br><span class="line">    ua_Client_MonitoredItems_create(client, &amp;request, contexts, (<span class="type">void</span> **)callbacks,</span><br><span class="line">                                    deleteCallbacks, &amp;response);</span><br><span class="line">    UA_UNLOCK(&amp;client-&gt;clientMutex);</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>抛去众多成员变量的设置，错误检查等等，我觉得最重要的是open62541如何处理监控变化–它怎么知道谁变化了，又怎么报告出去？</p>
<ul>
<li>调用路径：UA_Client_MonitoredItems_createDataChanges（加锁） -&gt; ua_Client_MonitoredItems_create -&gt; Service_CreateMonitoredItems -&gt; Operation_CreateMonitoredItem -&gt; UA_MonitoredItem_setMonitoringMode -&gt; UA_MonitoredItem_registerSampling（设置repeatedCallback）-&gt; UA_MonitoredItem_sampleCallBack（加锁） -&gt; monitoredItem_sampleCallBack -&gt;<br>UA_MonitoredItem_processSampleValue -&gt; UA_MonitoredItem_createDataChangeNotification (传出通知)</li>
<li>采样类型：根据采样间隔区分<ol>
<li>采样间隔为0，UA_MONITOREDITEMSAMPLINGTYPE_EVENT 类型表示此监控项用于事件监听，而不是持续采样数据值。</li>
<li>采样间隔等于发布间隔，可以只在收到publish request的时候才去获取值，而不是创建repeatedCallback</li>
<li>其余情况，根据间隔创建repeatedCallBack</li>
</ol>
</li>
</ul>
</li>
<li><p>第二个问题是怎么把监控和订阅结合起来？</p>
<ul>
<li>在Operation_CreateMonitoredItem中，有一个UA_MonitoredItem_init()方法，在这块设置了monitoredItem的订阅。</li>
<li>在Operation_CreateMonitoredItem -&gt; UA_Server_regisMonitoredItem中，monitoredItem被加入订阅的监控项链表</li>
</ul>
</li>
</ul>
<h2 id="Timer：管理repeatedCallback，周期事件"><a href="#Timer：管理repeatedCallback，周期事件" class="headerlink" title="Timer：管理repeatedCallback，周期事件"></a>Timer：管理repeatedCallback，周期事件</h2><h3 id="UA-Timer"><a href="#UA-Timer" class="headerlink" title="UA_Timer"></a>UA_Timer</h3><ul>
<li>三棵 Zip Tree：一个按时间排序，另一个按 ID 排序。这里的设计允许以高效的方式插入、查找和删除定时器项。还有一个用于处理entry时暂存节点使用。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="title function_">ZIP_HEAD</span><span class="params">(UA_TimerTree, UA_TimerEntry)</span> UA_TimerTree;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">ZIP_HEAD</span><span class="params">(UA_TimerIdTree, UA_TimerEntry)</span> UA_TimerIdTree;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    UA_TimerTree tree;     <span class="comment">/* The root of the time-sorted tree */</span></span><br><span class="line">    UA_TimerIdTree idTree; <span class="comment">/* The root of the id-sorted tree */</span></span><br><span class="line">    UA_UInt64 idCounter;   <span class="comment">/* Generate unique identifiers. Identifiers are</span></span><br><span class="line"><span class="comment">                            * always above zero. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> UA_MULTITHREADING &gt;= 100</span></span><br><span class="line">    UA_Lock timerMutex;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    UA_TimerTree processTree; <span class="comment">/* When the timer is processed, all entries that</span></span><br><span class="line"><span class="comment">                            * need processing now are moved to processTree.</span></span><br><span class="line"><span class="comment">                            * Then we iterate over that tree. */</span></span><br><span class="line">&#125; UA_Timer;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="UA-Entry"><a href="#UA-Entry" class="headerlink" title="UA_Entry"></a>UA_Entry</h3><ul>
<li>存储要周期触发的事项，包括计时策略，下一次触发的时间，时间间隔，id，回调函数等<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">UA_TimerEntry</span> &#123;</span></span><br><span class="line">    ZIP_ENTRY(UA_TimerEntry) treeEntry;</span><br><span class="line">    UA_TimerPolicy timerPolicy;      <span class="comment">/* Timer policy to handle cycle misses */</span></span><br><span class="line">    UA_DateTime nextTime;            <span class="comment">/* The next time when the callback is to be</span></span><br><span class="line"><span class="comment">                                    * executed */</span></span><br><span class="line">    UA_UInt64 interval;              <span class="comment">/* Interval in 100ns resolution. If the</span></span><br><span class="line"><span class="comment">                                    * interval is zero, the callback is not</span></span><br><span class="line"><span class="comment">                                    * repeated and removed after execution. */</span></span><br><span class="line">    UA_ApplicationCallback callback; <span class="comment">/* This is also a sentinel value. If the</span></span><br><span class="line"><span class="comment">                                    * callback is NULL, then the entry is</span></span><br><span class="line"><span class="comment">                                    * marked for deletion. */</span></span><br><span class="line">    <span class="type">void</span> *application;</span><br><span class="line">    <span class="type">void</span> *data;</span><br><span class="line"></span><br><span class="line">    ZIP_ENTRY(UA_TimerEntry) idTreeEntry;</span><br><span class="line">    UA_UInt64 id;                            <span class="comment">/* Id of the entry */</span></span><br><span class="line">&#125; UA_TimerEntry;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="UA-Timer-process-，处理zip-tree上面的事件"><a href="#UA-Timer-process-，处理zip-tree上面的事件" class="headerlink" title="UA_Timer_process()，处理zip tree上面的事件"></a>UA_Timer_process()，处理zip tree上面的事件</h2><p>+<br>    <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">UA_DateTime</span><br><span class="line"><span class="title function_">UA_Timer_process</span><span class="params">(UA_Timer *t, UA_DateTime nowMonotonic)</span> &#123;</span><br><span class="line">    UA_LOCK(&amp;t-&gt;timerMutex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Not reentrant. Don&#x27;t call _process from within _process. */</span></span><br><span class="line">    <span class="keyword">if</span>(!t-&gt;processTree.root) &#123;</span><br><span class="line">        <span class="comment">/* Move all entries &lt;= nowMonotonic to processTree */</span></span><br><span class="line">        <span class="comment">//_UNZIP splits at the key and moves elements &lt;= into the left output (right otherwise)</span></span><br><span class="line">        <span class="comment">// #define ZIP_UNZIP(name, head, key, left, right)</span></span><br><span class="line">        ZIP_UNZIP(UA_TimerTree, &amp;t-&gt;tree, &amp;nowMonotonic,</span><br><span class="line">                &amp;t-&gt;processTree, &amp;t-&gt;tree);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Consistency check. The smallest not-processed entry isn&#x27;t ready. */</span></span><br><span class="line">        UA_assert(!ZIP_MIN(UA_TimerTree, &amp;t-&gt;tree) ||</span><br><span class="line">                ZIP_MIN(UA_TimerTree, &amp;t-&gt;tree)-&gt;nextTime &gt; nowMonotonic);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* Iterate over the entries that need processing in-order. This also</span></span><br><span class="line"><span class="comment">        * moves them back to the regular time-ordered tree. */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">TimerProcessContext</span> <span class="title">ctx</span>;</span></span><br><span class="line">        ctx.t = t;</span><br><span class="line">        ctx.nowMonotonic = nowMonotonic;</span><br><span class="line">        <span class="comment">// processEntryCallback里面就是调用一下每个项的callback，更新下一次调用的时间并重新放回timeTree</span></span><br><span class="line">        ZIP_ITER(UA_TimerTree, &amp;t-&gt;processTree, processEntryCallback, &amp;ctx);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* Reset processTree. All entries are already moved to the normal tree. */</span></span><br><span class="line">        t-&gt;processTree.root = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Compute the timestamp of the earliest next callback */</span></span><br><span class="line">    UA_TimerEntry *first = ZIP_MIN(UA_TimerTree, &amp;t-&gt;tree);</span><br><span class="line">    UA_DateTime next = (first) ? first-&gt;nextTime : UA_INT64_MAX;</span><br><span class="line">    <span class="keyword">if</span>(next &lt; nowMonotonic)</span><br><span class="line">        next = nowMonotonic;</span><br><span class="line"></span><br><span class="line">    UA_UNLOCK(&amp;t-&gt;timerMutex);</span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="UA-EventLoopPOSIX-run-事件循环"><a href="#UA-EventLoopPOSIX-run-事件循环" class="headerlink" title="UA_EventLoopPOSIX_run()事件循环"></a>UA_EventLoopPOSIX_run()事件循环</h2><ul>
<li>时间循环内进行UA_Timer_process()，eventLoop会以上下文形式存在server中，并在server_run()中被启动run。每次执行完process之后，计算到下一次进行process需要的最少时间，然后调用UA_EventLoopPOSIX_pollFDs  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> UA_StatusCode</span><br><span class="line"><span class="title function_">UA_EventLoopPOSIX_run</span><span class="params">(UA_EventLoopPOSIX *el, UA_UInt32 timeout)</span> &#123;</span><br><span class="line">    UA_LOCK(&amp;el-&gt;elMutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(el-&gt;executing) &#123;</span><br><span class="line">        UA_LOG_ERROR(el-&gt;eventLoop.logger,</span><br><span class="line">                    UA_LOGCATEGORY_EVENTLOOP,</span><br><span class="line">                    <span class="string">&quot;Cannot run EventLoop from the run method itself&quot;</span>);</span><br><span class="line">        UA_UNLOCK(&amp;el-&gt;elMutex);</span><br><span class="line">        <span class="keyword">return</span> UA_STATUSCODE_BADINTERNALERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    el-&gt;executing = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(el-&gt;eventLoop.state == UA_EVENTLOOPSTATE_FRESH ||</span><br><span class="line">    el-&gt;eventLoop.state == UA_EVENTLOOPSTATE_STOPPED) &#123;</span><br><span class="line">        UA_LOG_WARNING(el-&gt;eventLoop.logger, UA_LOGCATEGORY_EVENTLOOP,</span><br><span class="line">                    <span class="string">&quot;Cannot iterate a stopped EventLoop&quot;</span>);</span><br><span class="line">        el-&gt;executing = <span class="literal">false</span>;</span><br><span class="line">        UA_UNLOCK(&amp;el-&gt;elMutex);</span><br><span class="line">        <span class="keyword">return</span> UA_STATUSCODE_BADINTERNALERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UA_LOG_TRACE(el-&gt;eventLoop.logger, UA_LOGCATEGORY_EVENTLOOP,</span><br><span class="line">                <span class="string">&quot;Iterate the EventLoop&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Process cyclic callbacks */</span></span><br><span class="line">    UA_DateTime dateBefore =</span><br><span class="line">        el-&gt;eventLoop.dateTime_nowMonotonic(&amp;el-&gt;eventLoop);</span><br><span class="line"></span><br><span class="line">    UA_UNLOCK(&amp;el-&gt;elMutex);</span><br><span class="line">    UA_DateTime dateNext = UA_Timer_process(&amp;el-&gt;timer, dateBefore);</span><br><span class="line">    UA_LOCK(&amp;el-&gt;elMutex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Process delayed callbacks here:</span></span><br><span class="line"><span class="comment">    * - Removes closed sockets already here instead of polling them again.</span></span><br><span class="line"><span class="comment">    * - The timeout for polling is selected to be ready in time for the next</span></span><br><span class="line"><span class="comment">    *   cyclic callback. So we want to do little work between the timeout</span></span><br><span class="line"><span class="comment">    *   running out and executing the due cyclic callbacks. */</span></span><br><span class="line">    processDelayed(el);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* A delayed callback could create another delayed callback (or re-add</span></span><br><span class="line"><span class="comment">    * itself). In that case we don&#x27;t want to wait (indefinitely) for an event</span></span><br><span class="line"><span class="comment">    * to happen. Process queued events but don&#x27;t sleep. Then process the</span></span><br><span class="line"><span class="comment">    * delayed callbacks in the next iteration. */</span></span><br><span class="line">    <span class="keyword">if</span>(el-&gt;delayedCallbacks != <span class="literal">NULL</span>)</span><br><span class="line">        timeout = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Compute the remaining time */</span></span><br><span class="line">    UA_DateTime maxDate = dateBefore + (timeout * UA_DATETIME_MSEC);</span><br><span class="line">    <span class="keyword">if</span>(dateNext &gt; maxDate)</span><br><span class="line">        dateNext = maxDate;</span><br><span class="line">    UA_DateTime listenTimeout =</span><br><span class="line">        dateNext - el-&gt;eventLoop.dateTime_nowMonotonic(&amp;el-&gt;eventLoop);</span><br><span class="line">    <span class="keyword">if</span>(listenTimeout &lt; <span class="number">0</span>)</span><br><span class="line">        listenTimeout = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Listen on the active file-descriptors (sockets) from the</span></span><br><span class="line"><span class="comment">    * ConnectionManagers */</span></span><br><span class="line">    UA_StatusCode rv = UA_EventLoopPOSIX_pollFDs(el, listenTimeout);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if the last EventSource was successfully stopped */</span></span><br><span class="line">    <span class="keyword">if</span>(el-&gt;eventLoop.state == UA_EVENTLOOPSTATE_STOPPING)</span><br><span class="line">        checkClosed(el);</span><br><span class="line"></span><br><span class="line">    el-&gt;executing = <span class="literal">false</span>;</span><br><span class="line">    UA_UNLOCK(&amp;el-&gt;elMutex);</span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/11/05/OPCUA-open62541%E8%AE%A2%E9%98%85%E5%8E%9F%E7%90%86/" data-id="cm347bkwz0000n0vc7meo0jho" data-title="OCPUA open62541-订阅监视" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/11/07/OPCUA-open62541%E5%8C%85%E6%8E%A5%E6%94%B6%E6%B5%81%E7%A8%8B/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          OPCUA open62541-包接收流程
        
      </div>
    </a>
  
  
    <a href="/2024/11/03/Spring-%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Spring-Bean&amp;依赖注入</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LCR119/">LCR119</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode101/">LeetCode101</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode101/%E5%9B%9E%E6%BA%AF/">回溯</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode101/%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2/">深度优先搜索</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Makefile/">Makefile</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/REDIS/">REDIS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/Dubbo/">Dubbo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/MIT-6824/">MIT-6824</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/RocketMQ/">RocketMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">系统架构</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/CSS/">CSS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/HTML/">HTML</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/TypeScript/">TypeScript</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%9E%E4%B9%A0/">实习</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%9E%E4%B9%A0/baosight/">baosight</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%9E%E4%B9%A0/baosight/OPC-UA/">OPC_UA</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%BD%91%E7%BB%9C%E7%B3%BB%E7%BB%9F/">网络系统</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/SQL/">SQL</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%B8%B8%E5%BC%80%E5%8F%91/">日常开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A7%91%E7%A0%94/">科研</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A7%91%E7%A0%94/ImageMatchingfromHandcraftedtoDeepFeatures-ASurvey/">ImageMatchingfromHandcraftedtoDeepFeatures:ASurvey</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%88%86%E6%B2%BB/">分治</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">动态规划</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%8D%95%E8%B0%83%E6%A0%88/">单调栈</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%B8%B8%E7%94%A8%E7%AE%97%E6%B3%95/">常用算法</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BE%E7%A8%8B/">课程</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BE%E7%A8%8B/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1/">软件设计</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/%E6%8F%8F%E8%BF%B0%E4%B8%8E%E9%9D%A2%E8%AF%95/">描述与面试</a></li></ul></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/11/30/RabbitMQ/">RabbitMQ</a>
          </li>
        
          <li>
            <a href="/2024/11/28/MySql/">MySql</a>
          </li>
        
          <li>
            <a href="/2024/11/17/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a>
          </li>
        
          <li>
            <a href="/2024/11/17/RocketMQ/">RocketMQ</a>
          </li>
        
          <li>
            <a href="/2024/11/16/Dubbo/">Dubbo</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>