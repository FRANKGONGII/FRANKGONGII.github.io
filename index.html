<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-JAVA线程池" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/06/JAVA%E7%BA%BF%E7%A8%8B%E6%B1%A0/" class="article-date">
  <time class="dt-published" datetime="2025-03-06T11:20:59.000Z" itemprop="datePublished">2025-03-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/JAVA/">JAVA</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/06/JAVA%E7%BA%BF%E7%A8%8B%E6%B1%A0/">JAVA线程池</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="线程池的状态"><a href="#线程池的状态" class="headerlink" title="线程池的状态"></a>线程池的状态</h2><ul>
<li>RUNNING，SHUTDOWN，STOP，TIDYING，TERMINATED</li>
<li><img src="/2025/03/06/JAVA%E7%BA%BF%E7%A8%8B%E6%B1%A0/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%8A%B6%E6%80%81.png" alt="alt text"></li>
</ul>
<h2 id="线程池的创建"><a href="#线程池的创建" class="headerlink" title="线程池的创建"></a>线程池的创建</h2><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                        <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                        <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                        TimeUnit unit,</span></span><br><span class="line"><span class="params">                        BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                        ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                        RejectedExecutionHandler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (corePoolSize &lt; <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize &lt;= <span class="number">0</span> ||</span><br><span class="line">        maximumPoolSize &lt; corePoolSize ||</span><br><span class="line">        keepAliveTime &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="keyword">if</span> (workQueue == <span class="literal">null</span> || threadFactory == <span class="literal">null</span> || handler == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="built_in">this</span>.acc = System.getSecurityManager() == <span class="literal">null</span> ?</span><br><span class="line">            <span class="literal">null</span> :</span><br><span class="line">            AccessController.getContext();</span><br><span class="line">    <span class="built_in">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">    <span class="built_in">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">    <span class="built_in">this</span>.workQueue = workQueue;</span><br><span class="line">    <span class="built_in">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">    <span class="built_in">this</span>.threadFactory = threadFactory;</span><br><span class="line">    <span class="built_in">this</span>.handler = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
<h3 id="线程个数计算"><a href="#线程个数计算" class="headerlink" title="线程个数计算"></a>线程个数计算</h3><p>我们将任务分为两种：IO 密集型和 CPU 密集型。<br>按照现在常见的线程池大小设计经验，可以参照如下设计：(以下的 N 为 CPU 个数)<br>CPU 密集型的话，线程池大小为 N + 1<br>IO 密集型的话，线程池大小为 2N + 1</p>
<h3 id="线程池构造参数"><a href="#线程池构造参数" class="headerlink" title="线程池构造参数"></a>线程池构造参数</h3><ol>
<li>corePoolSize：核心线程池的大小。线程池中始终保留的线程数量，即使这些线程处于空闲状态。当新任务提交时，如果当前线程数 &lt; 核心线程数，线程池会直接创建新线程执行任务。适合处理突发流量或保证最低并发能力。例如，corePoolSize&#x3D;5 表示始终有 5 个线程待命。</li>
<li>maximumPoolSize：最大线程池的大小。线程池允许创建的最大线程数（包括核心线程和非核心线程。当任务队列已满且当前线程数 &lt; 最大线程数时，线程池会创建新线程处理任务。用于应对高并发突发流量。例如，maximumPoolSize&#x3D;10 表示最多允许 10 个线程同时运行。</li>
<li>keepAliveTime：线程空闲存活时间。非核心线程（超出核心线程数的线程）在空闲状态下的存活时间。当线程空闲时间超过 keepAliveTime 时，该线程会被销毁，直到线程数恢复到核心线程数。由 unit 参数指定（如秒、毫秒）。节省资源。例如，设置 keepAliveTime&#x3D;60秒，非核心线程空闲超过 60 秒会被回收。默认情况下，keep-alive策略仅适用于超过corePoolSize线程的情况，但是方法allowCoreThreadTimeOut也可用于将此超时策略应用于核心线程，只要 keepAliveTime值不为零即可。</li>
<li>unit：存活时间单位。keepAliveTime 的时间单位。可选的值包括TimeUnit.SECONDS（秒）、TimeUnit.MILLISECONDS（毫秒）等。示例：unit&#x3D;TimeUnit.SECONDS 表示 keepAliveTime 以秒为单位。</li>
<li><strong>workQueue：任务队列。</strong>用于存放待执行任务的阻塞队列。当线程数达到核心线程数但在最大线程数内时，新任务会被放入队列等待执行。如果队列已满，且线程数 &lt; maximumPoolSize，创建新线程执行任务。如果队列已满，且线程数 ≥ maximumPoolSize，触发拒绝策略。</li>
</ol>
<ul>
<li>常用队列类型：<ol>
<li>LinkedBlockingQueue：无界队列（需警惕内存溢出）。使用无界的任务队列，线程池的任务队列可以无限制添加新任务，而线程池创建的最大线程数就是corePoolSize设置的数量，这种情况下maximumPoolSize设置的值是不会生效的（队列永远不会满），就算等待队列中有许多未执行的任务，线程池的数量达到了corePoolSize的值后也不会增加新的线程。</li>
<li>ArrayBlockingQueue：有界队列（需设置固定容量）。ArrayBlockingQueue是通过数组实现的有界队列。有界队列在与有限的maximumPoolSizes一起使用时有助于防止资源耗尽，但可能更难以调整和控制。使用ArrayBlockingQueue可以根据应用场景，预先估计池和队列的容量，互相权衡队列大小和最大池大小。若等待队列已满，即超过ArrayBlockingQueue初始化的容量，则继续创建线程，直到线程数量达到maximumPoolSize设置的最大线程数量，若大于maximumPoolSize，则执行拒绝策略。</li>
<li>SynchronousQueue：直接传递队列（不存储任务，必须立即执行）SynchronousQueue并不能算得上一个真正的队列，虽然实现了BlockingQueue接口，但是并没有容量，不能存储任务。只是维护一组线程，在等待着把元素加入或移出队列，相当于直接交接任务给具体执行的线程。如果没有立即可用的线程来运行任务，则尝试将任务排队失败，因此将构造一个新线程。所以当创建的线程数大于maximumPoolSize时，直接执行了拒绝策略抛出异常。在处理可能具有内部依赖关系的请求集时，此策略可避免锁定。这种队列方式通常需要无限的maximumPoolSizes以避免拒绝新提交的任务。当任务提交的平均到达速度快于线程处理速度时，线程存在无限增长的可能性，而CachedThreadPool正式采用这种形式。</li>
<li>PriorityBlockingQueue：这个队列和 LinkedBlockingQueue 类似，不同的是PriorityBlockingQueue 中的元素不是按照 FIFO 来排序的，而是按照元素的Comparator 来决定存取顺序的（这个功能也反映了存入 PriorityBlockingQueue 中的数据必须实现了 Comparator 接口）。</li>
<li>DelayedWorkQueue（延迟阻塞队列）：ScheduledThreadPool 和 SingleThreadScheduledExecutor 。DelayedWorkQueue 的内部元素并不是按照放入的时间排序，而是会按照延迟的时间长短对任务进行排序，内部采用的是“堆”的数据结构，可以保证每次出队的任务都是当前队列中执行时间最靠前的。DelayedWorkQueue 添加元素满了之后会自动扩容原来容量的 1&#x2F;2，即永远不会阻塞，最大扩容可达 Integer.MAX_VALUE，所以最多只能创建核心线程数的线程。</li>
</ol>
</li>
<li>作用：根据任务特性选择队列。例如，有界队列可防止内存溢出。</li>
</ul>
<ol start="6">
<li>threadFactory：线程工厂。用于创建新线程的工厂类。可以自定义线程的名称、优先级、是否守护线程等。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadFactoryBuilder</span>()</span><br><span class="line">    .setNameFormat(<span class="string">&quot;my-thread-%d&quot;</span>) <span class="comment">// 线程命名</span></span><br><span class="line">    .setDaemon(<span class="literal">false</span>)              <span class="comment">// 非守护线程</span></span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure></li>
<li>handler：拒绝策略。当任务队列已满且线程数达到最大线程数时，如何处理新提交的任务。</li>
</ol>
<ul>
<li><p>常用策略：</p>
<ol>
<li>AbortPolicy（默认）：直接抛出 RejectedExecutionException。</li>
<li>CallerRunsPolicy：由提交任务的线程自己执行任务（任务回退到调用者线程中运行）</li>
<li>DiscardPolicy：静默丢弃新任务。不抛出异常</li>
<li>DiscardOldestPolicy：丢弃队列中最旧的任务，然后重新提交新任务。</li>
</ol>
</li>
<li><p>根据业务容忍度选择策略。例如，日志任务可以丢弃，支付任务不能丢弃。</p>
</li>
<li><p>案例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    <span class="number">5</span>,                          <span class="comment">// corePoolSize=5</span></span><br><span class="line">    <span class="number">10</span>,                         <span class="comment">// maximumPoolSize=10</span></span><br><span class="line">    <span class="number">60</span>,                         <span class="comment">// keepAliveTime=60</span></span><br><span class="line">    TimeUnit.SECONDS,           <span class="comment">// 单位：秒</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">100</span>), <span class="comment">// workQueue容量100</span></span><br><span class="line">    Executors.defaultThreadFactory(), <span class="comment">// 默认线程工厂</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy() <span class="comment">// 拒绝策略：抛异常</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/03/06/JAVA%E7%BA%BF%E7%A8%8B%E6%B1%A0/" data-id="cm7yndu180000fkvch7cnfyx1" data-title="JAVA线程池" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-设计模式模版" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/04/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%A8%A1%E7%89%88/" class="article-date">
  <time class="dt-published" datetime="2025-03-04T01:44:57.000Z" itemprop="datePublished">2025-03-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%97%A5%E5%B8%B8%E5%BC%80%E5%8F%91/">日常开发</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/04/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%A8%A1%E7%89%88/">设计模式模版</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="去除繁琐的if-else"><a href="#去除繁琐的if-else" class="headerlink" title="去除繁琐的if-else"></a>去除繁琐的if-else</h2><ul>
<li><img src="/2025/03/04/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%A8%A1%E7%89%88/%E6%A0%91&%E9%93%BE%E8%B7%AF.png" alt="alt text"><br>对于大量if-else的流程，有链和树两种设计模式，其中树的流转方式可以是配置or节点业务决定</li>
</ul>
<h2 id="模式设计抽象模版的通用结构"><a href="#模式设计抽象模版的通用结构" class="headerlink" title="模式设计抽象模版的通用结构"></a>模式设计抽象模版的通用结构</h2><ul>
<li><img src="/2025/03/04/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%A8%A1%E7%89%88/%E6%A8%A1%E5%BC%8F%E8%AE%BE%E8%AE%A1%E9%80%9A%E7%94%A8%E7%BB%93%E6%9E%84.png" alt="alt text"></li>
</ul>
<h3 id="责任链"><a href="#责任链" class="headerlink" title="责任链"></a>责任链</h3><ul>
<li>实现：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 策略映射器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StrategyMapper</span>&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取待执行策略</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> requestParameter 入参</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> dynamicContext   上下文</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> 返参</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception 异常</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    StrategyHandler&lt;T, D, R&gt; <span class="title function_">get</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 策略受理器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StrategyHandler</span>&lt;T, D, R&gt; &#123;</span><br><span class="line">    <span class="comment">// lamda表达式写法，等价于下面的</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        StrategyHandler DEFAULT = new StrategyHandler() &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public Object apply(Object requestParameter, Object dynamicContext) throws Exception &#123;</span></span><br><span class="line"><span class="comment">                return null;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">StrategyHandler</span> <span class="variable">DEFAULT</span> <span class="operator">=</span> (T, D) -&gt; <span class="literal">null</span>;</span><br><span class="line">    R <span class="title function_">apply</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 策略路由器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractStrategyRouter</span>&lt;T, D, R&gt; <span class="keyword">implements</span> <span class="title class_">StrategyMapper</span>&lt;T, D, R&gt;, StrategyHandler&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">protected</span> StrategyHandler&lt;T, D, R&gt; defaultStrategyHandler = StrategyHandler.DEFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">router</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        StrategyHandler&lt;T, D, R&gt; strategyHandler = get(requestParameter, dynamicContext);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != strategyHandler) <span class="keyword">return</span> strategyHandler.apply(requestParameter, dynamicContext);</span><br><span class="line">        <span class="keyword">return</span> defaultStrategyHandler.apply(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="实现例子"><a href="#实现例子" class="headerlink" title="实现例子"></a>实现例子</h2><ul>
<li><img src="/2025/03/04/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%A8%A1%E7%89%88/%E4%BE%8B%E5%AD%90-%E9%93%BE%E8%B7%AF.png" alt="alt text"><ul>
<li>首先，对通用设计模式树结构扩展出异步数据加载区，这样可以把接口实现中所需的数据前置到异步数据加载区完成加载操作。以此提高接口的响应效率。</li>
<li>串联功能节点，并在 MarketNode 节点，添加数据加载操作。</li>
</ul>
</li>
</ul>
<h3 id="多线程模块"><a href="#多线程模块" class="headerlink" title="多线程模块"></a>多线程模块</h3><ul>
<li>实现代码：添加了一个 multiThread 方法，这个方法在执行 apply 受理业务功能逻辑实现前完成对数据的加载调用。之后在提供一个 doApply 受理的抽象方法，让使用方完成这个方法的实现即可。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractMultiThreadStrategyRouter</span>&lt;T, D, R&gt; <span class="keyword">implements</span> <span class="title class_">StrategyMapper</span>&lt;T, D, R&gt;, StrategyHandler&lt;T, D, R&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="keyword">protected</span> StrategyHandler&lt;T, D, R&gt; defaultStrategyHandler = StrategyHandler.DEFAULT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">router</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        StrategyHandler&lt;T, D, R&gt; strategyHandler = get(requestParameter, dynamicContext);</span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != strategyHandler) <span class="keyword">return</span> strategyHandler.apply(requestParameter, dynamicContext);</span><br><span class="line">        <span class="keyword">return</span> defaultStrategyHandler.apply(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">apply</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 异步加载数据</span></span><br><span class="line">        multiThread(requestParameter, dynamicContext);</span><br><span class="line">        <span class="comment">// 业务流程受理</span></span><br><span class="line">        <span class="keyword">return</span> doApply(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 异步加载数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">multiThread</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException, TimeoutException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 业务流程受理</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> R <span class="title function_">doApply</span><span class="params">(T requestParameter, D dynamicContext)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="具体业务使用"><a href="#具体业务使用" class="headerlink" title="具体业务使用"></a>具体业务使用</h3><ul>
<li>抽象支持类，对于一个domain内类似的业务可以作为一个共同的基类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DynamicContext, TrialBalanceEntity&gt; <span class="keyword">extends</span> <span class="title class_">AbstractMultiThreadStrategyRouter</span>&lt;cn.bugstack.domain.activity.model.entity.MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, cn.bugstack.domain.activity.model.entity.TrialBalanceEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">long</span> <span class="variable">timeout</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">protected</span> IActivityRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">multiThread</span><span class="params">(cn.bugstack.domain.activity.model.entity.MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 缺省的方法</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用多线程的节点，不使用多线程就不重写multi方法即可<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MarketNode</span> <span class="keyword">extends</span> <span class="title class_">AbstractGroupBuyMarketSupport</span>&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ThreadPoolExecutor threadPoolExecutor;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * &lt;a href=&quot;https://bugstack.cn/md/road-map/spring-dependency-injection.html&quot;&gt;Spring 注入详细说明&lt;/a&gt;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, IDiscountCalculateService&gt; discountCalculateServiceMap;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ErrorNode errorNode;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TagNode tagNode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">multiThread</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException, TimeoutException &#123;</span><br><span class="line">        <span class="comment">// 异步查询活动配置</span></span><br><span class="line">        <span class="type">QueryGroupBuyActivityDiscountVOThreadTask</span> <span class="variable">queryGroupBuyActivityDiscountVOThreadTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryGroupBuyActivityDiscountVOThreadTask</span>(requestParameter.getActivityId(), requestParameter.getSource(), requestParameter.getChannel(), requestParameter.getGoodsId(), repository);</span><br><span class="line">        FutureTask&lt;GroupBuyActivityDiscountVO&gt; groupBuyActivityDiscountVOFutureTask = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(queryGroupBuyActivityDiscountVOThreadTask);</span><br><span class="line">        threadPoolExecutor.execute(groupBuyActivityDiscountVOFutureTask);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 异步查询商品信息 - 在实际生产中，商品有同步库或者调用接口查询。这里暂时使用DB方式查询。</span></span><br><span class="line">        <span class="type">QuerySkuVOFromDBThreadTask</span> <span class="variable">querySkuVOFromDBThreadTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QuerySkuVOFromDBThreadTask</span>(requestParameter.getGoodsId(), repository);</span><br><span class="line">        FutureTask&lt;SkuVO&gt; skuVOFutureTask = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(querySkuVOFromDBThreadTask);</span><br><span class="line">        threadPoolExecutor.execute(skuVOFutureTask);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入上下文 - 对于一些复杂场景，获取数据的操作，有时候会在下N个节点获取，这样前置查询数据，可以提高接口响应效率</span></span><br><span class="line">        dynamicContext.setGroupBuyActivityDiscountVO(groupBuyActivityDiscountVOFutureTask.get(timeout, TimeUnit.MINUTES));</span><br><span class="line">        dynamicContext.setSkuVO(skuVOFutureTask.get(timeout, TimeUnit.MINUTES));</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;拼团商品查询试算服务-MarketNode userId:&#123;&#125; 异步线程加载数据「GroupBuyActivityDiscountVO、SkuVO」完成&quot;</span>, requestParameter.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> TrialBalanceEntity <span class="title function_">doApply</span><span class="params">(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;拼团商品查询试算服务-MarketNode userId:&#123;&#125; requestParameter:&#123;&#125;&quot;</span>, requestParameter.getUserId(), JSON.toJSONString(requestParameter));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取上下文数据</span></span><br><span class="line">        <span class="type">GroupBuyActivityDiscountVO</span> <span class="variable">groupBuyActivityDiscountVO</span> <span class="operator">=</span> dynamicContext.getGroupBuyActivityDiscountVO();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyActivityDiscountVO) &#123;</span><br><span class="line">            <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        GroupBuyActivityDiscountVO.<span class="type">GroupBuyDiscount</span> <span class="variable">groupBuyDiscount</span> <span class="operator">=</span> groupBuyActivityDiscountVO.getGroupBuyDiscount();</span><br><span class="line">        <span class="type">SkuVO</span> <span class="variable">skuVO</span> <span class="operator">=</span> dynamicContext.getSkuVO();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == groupBuyDiscount || <span class="literal">null</span> == skuVO) &#123;</span><br><span class="line">            <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 优惠试算</span></span><br><span class="line">        <span class="type">IDiscountCalculateService</span> <span class="variable">discountCalculateService</span> <span class="operator">=</span> discountCalculateServiceMap.get(groupBuyDiscount.getMarketPlan());</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == discountCalculateService) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;不存在&#123;&#125;类型的折扣计算服务，支持类型为:&#123;&#125;&quot;</span>, groupBuyDiscount.getMarketPlan(), JSON.toJSONString(discountCalculateServiceMap.keySet()));</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AppException</span>(ResponseCode.E0001.getCode(), ResponseCode.E0001.getInfo());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 折扣价格</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">payPrice</span> <span class="operator">=</span> discountCalculateService.calculate(requestParameter.getUserId(), skuVO.getOriginalPrice(), groupBuyDiscount);</span><br><span class="line">        dynamicContext.setDeductionPrice(skuVO.getOriginalPrice().subtract(payPrice));</span><br><span class="line">        dynamicContext.setPayPrice(payPrice);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> router(requestParameter, dynamicContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> StrategyHandler&lt;MarketProductEntity, DefaultActivityStrategyFactory.DynamicContext, TrialBalanceEntity&gt; get(MarketProductEntity requestParameter, DefaultActivityStrategyFactory.DynamicContext dynamicContext) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 不存在配置的拼团活动，走异常节点</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == dynamicContext.getGroupBuyActivityDiscountVO() || <span class="literal">null</span> == dynamicContext.getSkuVO() || <span class="literal">null</span> == dynamicContext.getDeductionPrice()) &#123;</span><br><span class="line">            <span class="keyword">return</span> errorNode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tagNode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="配置线程池-yaml配置properties，config类实例化"><a href="#配置线程池-yaml配置properties，config类实例化" class="headerlink" title="配置线程池 - yaml配置properties，config类实例化"></a>配置线程池 - yaml配置properties，config类实例化</h3><ul>
<li>threadPoolExecutor 线程池配置的是 CallerRunsPolicy 策略。当线程池中的任务队列已满，并且没有空闲线程可以执行新任务时，CallerRunsPolicy 会将任务回退到调用者线程中运行。这种策略适用于不希望丢失任务且可以接受调用者线程被阻塞的场景。</li>
<li>配置代码 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(ThreadPoolConfigProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(ThreadPoolExecutor.class)</span></span><br><span class="line">    <span class="keyword">public</span> ThreadPoolExecutor <span class="title function_">threadPoolExecutor</span><span class="params">(ThreadPoolConfigProperties properties)</span> <span class="keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException &#123;</span><br><span class="line">        <span class="comment">// 实例化策略</span></span><br><span class="line">        RejectedExecutionHandler handler;</span><br><span class="line">        <span class="keyword">switch</span> (properties.getPolicy())&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;AbortPolicy&quot;</span>:</span><br><span class="line">                handler = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;DiscardPolicy&quot;</span>:</span><br><span class="line">                handler = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.DiscardPolicy();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;DiscardOldestPolicy&quot;</span>:</span><br><span class="line">                handler = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.DiscardOldestPolicy();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;CallerRunsPolicy&quot;</span>:</span><br><span class="line">                handler = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                handler = <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建线程池</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">                properties.getCorePoolSize(),</span><br><span class="line">                properties.getMaxPoolSize(),</span><br><span class="line">                properties.getKeepAliveTime(),</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(properties.getBlockQueueSize()),</span><br><span class="line">                Executors.defaultThreadFactory(),</span><br><span class="line">                handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;thread.pool.executor.config&quot;, ignoreInvalidFields = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolConfigProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 核心线程数 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">corePoolSize</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">    <span class="comment">/** 最大线程数 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">maxPoolSize</span> <span class="operator">=</span> <span class="number">200</span>;</span><br><span class="line">    <span class="comment">/** 最大等待时间 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">keepAliveTime</span> <span class="operator">=</span> <span class="number">10L</span>;</span><br><span class="line">    <span class="comment">/** 最大队列数 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">blockQueueSize</span> <span class="operator">=</span> <span class="number">5000</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * AbortPolicy：丢弃任务并抛出RejectedExecutionException异常。</span></span><br><span class="line"><span class="comment">    * DiscardPolicy：直接丢弃任务，但是不会抛出异常</span></span><br><span class="line"><span class="comment">    * DiscardOldestPolicy：将最早进入队列的任务删除，之后再尝试加入队列的任务被拒绝</span></span><br><span class="line"><span class="comment">    * CallerRunsPolicy：如果任务添加线程池失败，那么主线程自己执行该任务</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">policy</span> <span class="operator">=</span> <span class="string">&quot;AbortPolicy&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/03/04/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%A8%A1%E7%89%88/" data-id="cm7yndu1e0003fkvcgc4812jp" data-title="设计模式模版" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-毕设-后端与核心算法" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/03/%E6%AF%95%E8%AE%BE-%E5%90%8E%E7%AB%AF%E4%B8%8E%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95/" class="article-date">
  <time class="dt-published" datetime="2025-03-03T02:48:03.000Z" itemprop="datePublished">2025-03-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a>►<a class="article-category-link" href="/categories/%E9%A1%B9%E7%9B%AE/%E6%AF%95%E8%AE%BE/">毕设</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/03/%E6%AF%95%E8%AE%BE-%E5%90%8E%E7%AB%AF%E4%B8%8E%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95/">毕设-后端与核心算法</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/03/03/%E6%AF%95%E8%AE%BE-%E5%90%8E%E7%AB%AF%E4%B8%8E%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95/" data-id="cm7yndu1d0002fkvc0plbff3r" data-title="毕设-后端与核心算法" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Mysql-锁机制" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/02/Mysql-%E9%94%81%E6%9C%BA%E5%88%B6/" class="article-date">
  <time class="dt-published" datetime="2025-03-02T13:38:56.000Z" itemprop="datePublished">2025-03-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>►<a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/">Mysql</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/02/Mysql-%E9%94%81%E6%9C%BA%E5%88%B6/">Mysql-锁机制</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h2><ul>
<li>表锁是针对整个表进行加锁，当一个事务对表加锁后，其他事务不能对该表进行任何操作，直到锁被释放。表锁的粒度较粗，适合低并发的场景，或者在对整个表进行操作时使用。MyISAM 存储引擎只支持表锁。</li>
<li>应用场景：<ul>
<li>批量操作：当需要对整个表进行批量插入、更新或删除时，表锁可以确保操作的原子性。</li>
<li>数据迁移：在数据迁移或备份时，表锁可以防止其他事务对表进行修改，确保数据的一致性。</li>
</ul>
</li>
<li>实现方式：在事务中添加LOCK TABLES命令即可显示地添加表锁<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">-- 对 group_buy_activity 表加写锁</span></span><br><span class="line">    LOCK TABLES group_buy_activity WRITE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 对表进行批量插入</span></span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> group_buy_activity (activity_id, source, channel, goods_id, discount_id, group_type, take_limit_count, target, valid_time, status, start_time, end_time, tag_id, tag_scope, create_time, update_time)</span><br><span class="line">    <span class="keyword">VALUES</span></span><br><span class="line">    (<span class="number">100124</span>, <span class="string">&#x27;s02&#x27;</span>, <span class="string">&#x27;c02&#x27;</span>, <span class="string">&#x27;9890002&#x27;</span>, <span class="string">&#x27;25120208&#x27;</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">30</span>, <span class="number">1</span>, <span class="string">&#x27;2024-12-08 10:19:40&#x27;</span>, <span class="string">&#x27;2024-12-08 10:19:40&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;2024-12-08 10:19:40&#x27;</span>, <span class="string">&#x27;2024-12-08 10:19:40&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 解锁表</span></span><br><span class="line">    UNLOCK TABLES;</span><br><span class="line">  ```  </span><br><span class="line"></span><br><span class="line">## 行锁</span><br><span class="line"><span class="operator">+</span> 行锁 是针对表中的某一行数据进行加锁，其他事务可以访问表中的其他行，但不能访问被锁定的行。行锁的粒度更细，适合高并发的场景，能够减少锁冲突，提高并发性能。</span><br><span class="line"><span class="operator">+</span> 应用场景：</span><br><span class="line">  <span class="operator">+</span> 高并发读写：当多个事务需要同时读写表中的不同行时，行锁可以避免锁冲突，提高并发性能。</span><br><span class="line">  <span class="operator">+</span> 事务处理：在需要保证事务的原子性和一致性时，行锁可以确保事务中的操作不会被其他事务干扰。</span><br><span class="line"><span class="operator">+</span> 实现方式：在 InnoDB 存储引擎中，行锁是默认的锁机制。你可以在事务中使用 <span class="keyword">SELECT</span> ... <span class="keyword">FOR</span> <span class="keyword">UPDATE</span> 或 <span class="keyword">SELECT</span> ... LOCK <span class="keyword">IN</span> SHARE MODE 来显式地加行锁</span><br><span class="line">  ```<span class="keyword">sql</span></span><br><span class="line">    <span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 对 id = 1 的行加写锁</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> group_buy_activity <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 对 id = 1 的行进行更新</span></span><br><span class="line">    <span class="keyword">UPDATE</span> group_buy_activity <span class="keyword">SET</span> status <span class="operator">=</span> <span class="number">1</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/03/02/Mysql-%E9%94%81%E6%9C%BA%E5%88%B6/" data-id="cm7rs41uo0001lkvc4f83cfji" data-title="Mysql-锁机制" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Maven" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/02/Maven/" class="article-date">
  <time class="dt-published" datetime="2025-03-02T13:32:52.000Z" itemprop="datePublished">2025-03-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%97%A5%E5%B8%B8%E5%BC%80%E5%8F%91/">日常开发</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/02/Maven/">Maven</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Maven-Archetype"><a href="#Maven-Archetype" class="headerlink" title="Maven Archetype"></a>Maven Archetype</h2><ul>
<li>什么是Maven Archetype：Archetype即是项目骨架，在老版本IDEA中创建Maven项目时，每次都会选择⼀个项目骨架，每个骨架对应特定的原型，在项目开发中，总会需要自定义自己项目的骨架，统⼀项目骨架，在创建新的服务时就会减少很多不必要的麻烦。2022.1版本的IDEA将入口收敛至Maven Archetype，使用项目骨架均从该入口创建新项目。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/03/02/Maven/" data-id="cm7rs41um0000lkvchrmjclb7" data-title="Maven" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-LeetCodeHot100" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/02/27/LeetCodeHot100/" class="article-date">
  <time class="dt-published" datetime="2025-02-27T13:46:25.000Z" itemprop="datePublished">2025-02-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/LeetCode%E5%88%B7%E9%A2%98/">LeetCode刷题</a>►<a class="article-category-link" href="/categories/LeetCode%E5%88%B7%E9%A2%98/Hot100/">Hot100</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/02/27/LeetCodeHot100/">LeetCodeHot100</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="3-无重复字符的最长子串"><a href="#3-无重复字符的最长子串" class="headerlink" title="3 无重复字符的最长子串"></a>3 无重复字符的最长子串</h1><ul>
<li>给定一个字符串 s ，请你找出其中不含有重复字符的最长子串的长度。</li>
<li>思路：常见的右扩左缩类型  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">lengthOfLongestSubstring</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] cnt = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">128</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; s.length(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cnt[s.charAt(i)] != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 有重复</span></span><br><span class="line">                <span class="keyword">while</span> (cnt[s.charAt(i)] != <span class="number">0</span>) &#123;</span><br><span class="line">                    cnt[s.charAt(i - len)]--;</span><br><span class="line">                    len--;</span><br><span class="line">                &#125;</span><br><span class="line">                len++;</span><br><span class="line">                cnt[s.charAt(i)]++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 没重复</span></span><br><span class="line">                cnt[s.charAt(i)]++;</span><br><span class="line">                len++;</span><br><span class="line">                ret = Math.max(ret, len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> ret;   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="128-最长连续序列"><a href="#128-最长连续序列" class="headerlink" title="128 最长连续序列"></a>128 最长连续序列</h1><ul>
<li>给定一个未排序的整数数组nums ，找出数字连续的最长序列（不要求序列元素在原数组中连续）的长度。</li>
<li>思路：用不存在num - 1作为最关键的判断，这样每次进入循环都是保证这个元素是序列的开始<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">longestConsecutive</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        Set&lt;Integer&gt; num_set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Integer&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> num : nums) &#123;</span><br><span class="line">            num_set.add(num);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">longestStreak</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> num : num_set) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!num_set.contains(num - <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">currentNum</span> <span class="operator">=</span> num;</span><br><span class="line">                <span class="type">int</span> <span class="variable">currentStreak</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (num_set.contains(currentNum + <span class="number">1</span>)) &#123;</span><br><span class="line">                    currentNum++;</span><br><span class="line">                    currentStreak++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                longestStreak = Math.max(longestStreak, currentStreak);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> longestStreak;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/02/27/LeetCodeHot100/" data-id="cm7qdvwz50001jsvcbjoh5zut" data-title="LeetCodeHot100" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-LeetCode刷题-滑动窗口" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/02/27/LeetCode%E5%88%B7%E9%A2%98-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/" class="article-date">
  <time class="dt-published" datetime="2025-02-27T03:34:44.000Z" itemprop="datePublished">2025-02-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/LeetCode%E5%88%B7%E9%A2%98/">LeetCode刷题</a>►<a class="article-category-link" href="/categories/LeetCode%E5%88%B7%E9%A2%98/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/">滑动窗口</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/02/27/LeetCode%E5%88%B7%E9%A2%98-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/">LeetCode刷题-滑动窗口</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="典型"><a href="#典型" class="headerlink" title="典型"></a>典型</h1><p>2831</p>
<h1 id="定长窗口"><a href="#定长窗口" class="headerlink" title="定长窗口"></a>定长窗口</h1><p>什么时候可以用定长窗口？“长度”至少为k的情况下满足最少最小，或者指定“长度”为k</p>
<ul>
<li>模版：<strong>初始化，填充满第一个窗口 - 入 - 操作 - 出</strong></li>
</ul>
<h2 id="1456-定长子串中元音的最大数目"><a href="#1456-定长子串中元音的最大数目" class="headerlink" title="1456 定长子串中元音的最大数目"></a>1456 定长子串中元音的最大数目</h2><ul>
<li><p>给你字符串 s 和整数 k 。<br>请返回字符串 s 中长度为 k 的单个子字符串中可能包含的最大元音字母数。<br>英文中的 元音字母 为（a, e, i, o, u）。</p>
</li>
<li><p>思路：<strong>经典的(初始化) - 入 - 更新 - 出</strong>，需要注意的是不要忘了窗口长度等于整个数组长度的情况，可能要在这种情况下及时更新结果</p>
</li>
<li><p>一个有意思的小技巧是把string转成char[]更快一点，取出下标比charAt快</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maxVowels</span><span class="params">(String S, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="type">char</span>[] s = S.toCharArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">vowel</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; s.length; i++) &#123;</span><br><span class="line">            <span class="comment">// 1. 进入窗口</span></span><br><span class="line">            <span class="keyword">if</span> (s[i] == <span class="string">&#x27;a&#x27;</span> || s[i] == <span class="string">&#x27;e&#x27;</span> || s[i] == <span class="string">&#x27;i&#x27;</span> || s[i] == <span class="string">&#x27;o&#x27;</span> || s[i] == <span class="string">&#x27;u&#x27;</span>) &#123;</span><br><span class="line">                vowel++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; k - <span class="number">1</span>) &#123; <span class="comment">// 窗口大小不足 k</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 2. 更新答案</span></span><br><span class="line">            ans = Math.max(ans, vowel);</span><br><span class="line">            <span class="comment">// 3. 离开窗口</span></span><br><span class="line">            <span class="type">char</span> <span class="variable">out</span> <span class="operator">=</span> s[i - k + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (out == <span class="string">&#x27;a&#x27;</span> || out == <span class="string">&#x27;e&#x27;</span> || out == <span class="string">&#x27;i&#x27;</span> || out == <span class="string">&#x27;o&#x27;</span> || out == <span class="string">&#x27;u&#x27;</span>) &#123;</span><br><span class="line">                vowel--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2841-几乎唯一数组的最大和"><a href="#2841-几乎唯一数组的最大和" class="headerlink" title="2841 几乎唯一数组的最大和"></a>2841 几乎唯一数组的最大和</h2><ul>
<li>给你一个整数数组 nums 和两个正整数 m 和 k 。请你返回 nums 中长度为 k 的 几乎唯一 子数组的 最大和 ，如果不存在几乎唯一子数组，请你返回 0 。如果 nums 的一个子数组有至少 m 个互不相同的元素，我们称它是几乎唯一子数组。子数组指的是一个数组中一段连续 非空 的元素序列。</li>
<li>思路：结合了经典定长窗口模式和map操作<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">maxSum</span><span class="params">(List&lt;Integer&gt; nums, <span class="type">int</span> m, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now_sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        Map&lt;Integer, Integer&gt; cnt = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nums.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; k) &#123;</span><br><span class="line">                now_sum += nums.get(i);</span><br><span class="line">                cnt.put(nums.get(i), cnt.getOrDefault(nums.get(i), <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">outIndex</span> <span class="operator">=</span> i - k;</span><br><span class="line">                <span class="keyword">if</span> (cnt.keySet().size() &gt;= m) &#123;</span><br><span class="line">                    ret = Math.max(ret, now_sum);</span><br><span class="line">                &#125; </span><br><span class="line">                <span class="keyword">if</span> (cnt.get(nums.get(outIndex)) == <span class="number">1</span>) &#123;</span><br><span class="line">                    cnt.remove(nums.get(outIndex));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    cnt.put(nums.get(outIndex), cnt.get(nums.get(outIndex)) - <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                cnt.put(nums.get(i), cnt.getOrDefault(nums.get(i), <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">                now_sum -= nums.get(outIndex);</span><br><span class="line">                now_sum += nums.get(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cnt.keySet().size() &gt;= m) &#123;</span><br><span class="line">            ret = Math.max(ret, now_sum);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2134-最少次数交换所有1"><a href="#2134-最少次数交换所有1" class="headerlink" title="2134 最少次数交换所有1"></a>2134 最少次数交换所有1</h2><ul>
<li>交换定义为选中一个数组中的两个互不相同的位置并交换二者的值。环形数组是一个数组，可以认为第一个元素和最后一个元素相邻。给你一个二进制环形数组nums ，返回在任意位置将数组中的所有1聚集在一起需要的最少交换次数。</li>
<li>思路：比较好想的是直接拓展3倍，然后用1个数的滑动窗口。当然也可以不扩大数组：当起始位置从 i−1 增加到 i 时，nums[i−1] 被从区间内移除，而 nums[(i+cnt−1) mod n] 被加入区间内。因此如果前者为 0，就将 0 的个数减少 1；如果后者为 0，就将 0 的个数增加 1。  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minSwaps</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">        <span class="comment">// 00001111000111100000</span></span><br><span class="line">        <span class="comment">// 3 + 4 + 5 + 6</span></span><br><span class="line">        <span class="comment">// 先找到包含所有1的最短</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> nums.length;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">one_cnt</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span>[] new_nums = <span class="keyword">new</span> <span class="title class_">int</span>[len * <span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">                new_nums[len * i + j] = nums[j];</span><br><span class="line">                <span class="keyword">if</span> (nums[j] == <span class="number">1</span>) &#123;</span><br><span class="line">                    one_cnt++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//System.out.println(Arrays.toString(new_nums) + &quot; &quot; + one_cnt/3);</span></span><br><span class="line">        one_cnt /= <span class="number">3</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">now_sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">max_sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; new_nums.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; one_cnt) &#123;</span><br><span class="line">                now_sum += new_nums[i];</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;   </span><br><span class="line">            <span class="type">int</span> <span class="variable">outIndex</span> <span class="operator">=</span> i - one_cnt;</span><br><span class="line">            max_sum = Math.max(max_sum, now_sum);</span><br><span class="line">            now_sum -= new_nums[outIndex];</span><br><span class="line">            now_sum += new_nums[i];</span><br><span class="line">            max_sum = Math.max(max_sum, now_sum);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//System.out.println(max_sum);</span></span><br><span class="line">        <span class="keyword">if</span> (max_sum == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1 0 0 1 1 0 1 0 1</span></span><br><span class="line">        <span class="keyword">return</span> one_cnt - max_sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">minSwaps</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> n = nums.<span class="built_in">size</span>();</span><br><span class="line">        <span class="type">int</span> cnt = <span class="built_in">accumulate</span>(nums.<span class="built_in">begin</span>(), nums.<span class="built_in">end</span>(), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (cnt == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> cur = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; cnt; ++i) &#123;</span><br><span class="line">            cur += (<span class="number">1</span> - nums[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> ans = cur;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[i - <span class="number">1</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">                --cur;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (nums[(i + cnt - <span class="number">1</span>) % n] == <span class="number">0</span>) &#123;</span><br><span class="line">                ++cur;</span><br><span class="line">            &#125;</span><br><span class="line">            ans = <span class="built_in">min</span>(ans, cur);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="1297-子串的最大出现次数"><a href="#1297-子串的最大出现次数" class="headerlink" title="1297 子串的最大出现次数"></a>1297 子串的最大出现次数</h2><ul>
<li>给你一个字符串 s ，请你返回满足以下条件且出现次数最大的 任意 子串的出现次数：<br>子串中不同字母的数目必须小于等于 maxLetters 。<br>子串的长度必须大于等于 minSize 且小于等于 maxSize 。</li>
<li>思路：关键是想到只需要考虑minSize的子串：假设字符串 T 在给定的字符串 S 中出现的次数为 k，那么 T 的任意一个子串出现的次数至少也为 k，即 T 的任意一个子串在 S 中出现的次数不会少于 T 本身。这样我们就可以断定，在所有满足条件且出现次数最多的的字符串中，一定有一个的长度恰好为 minSize。我们可以使用反证法证明上述的结论：假设所有满足条件且出现次数最多的字符串中没有长度为 minSize 的，不妨任取其中的一个长度为 l 的字符串，根据假设，有 l &gt; minSize。此时我们再任取该字符串的一个长度为 minSize 的子串，子串出现的次数不会少于原字符串出现的次数，与假设相矛盾。  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maxFreq</span><span class="params">(String s, <span class="type">int</span> maxLetters, <span class="type">int</span> minSize, <span class="type">int</span> maxSize)</span> &#123;</span><br><span class="line">        Map&lt;Character, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Map&lt;String, Integer&gt; cntString = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> s.length();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">tarLen</span> <span class="operator">=</span> minSize; tarLen &lt;= minSize; tarLen++) &#123;</span><br><span class="line">            map = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i &lt; tarLen) &#123;</span><br><span class="line">                    map.put(s.charAt(i), map.getOrDefault(s.charAt(i), <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">if</span> (i == tarLen - <span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (map.keySet().size() &lt;= maxLetters) &#123;</span><br><span class="line">                            cntString.put(s.substring(<span class="number">0</span>, tarLen), <span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">char</span> <span class="variable">outChar</span> <span class="operator">=</span> s.charAt(i - tarLen);</span><br><span class="line">                <span class="keyword">if</span> (map.get(outChar) == <span class="number">1</span>) &#123;</span><br><span class="line">                    map.remove(outChar);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    map.put(outChar, map.get(outChar) - <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                map.put(s.charAt(i), map.getOrDefault(s.charAt(i), <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (map.keySet().size() &lt;= maxLetters) &#123;</span><br><span class="line">                    cntString.put(s.substring(i - tarLen + <span class="number">1</span>, i + <span class="number">1</span>), </span><br><span class="line">                    cntString.getOrDefault(s.substring(i - tarLen + <span class="number">1</span>, i + <span class="number">1</span>), <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (String k : cntString.keySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cntString.get(k) &gt; max) &#123;</span><br><span class="line">                max = cntString.get(k);</span><br><span class="line">                ret = k;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2653-滑动子数组的美丽值"><a href="#2653-滑动子数组的美丽值" class="headerlink" title="2653 滑动子数组的美丽值"></a>2653 滑动子数组的美丽值</h2><ul>
<li>给你一个长度为 n 的整数数组 nums ，请你求出每个长度为 k 的子数组的 美丽值 。<br>一个子数组的 美丽值 定义为：如果子数组中第 x 小整数 是 负数 ，那么美丽值为第 x 小的数，否则美丽值为 0 。<br>请你返回一个包含 n - k + 1 个整数的数组，依次 表示数组中从第一个下标开始，每个长度为 k 的子数组的 美丽值 。<br>子数组指的是数组中一段连续 非空 的元素序列。</li>
<li>思路：一个关键点是数有范围，在-50-50，也就是说在子数组内查看数组内元素的出现情况是常数级别时间<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[] getSubarrayBeauty(<span class="type">int</span>[] nums, <span class="type">int</span> k, <span class="type">int</span> x) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">BIAS</span> <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line">        <span class="type">int</span>[] cnt = <span class="keyword">new</span> <span class="title class_">int</span>[BIAS * <span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; k - <span class="number">1</span>; i++) &#123; <span class="comment">// 先往窗口内添加 k-1 个数</span></span><br><span class="line">            cnt[nums[i] + BIAS]++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> nums.length;</span><br><span class="line">        <span class="type">int</span>[] ans = <span class="keyword">new</span> <span class="title class_">int</span>[n - k + <span class="number">1</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> k - <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            cnt[nums[i] + BIAS]++; <span class="comment">// 进入窗口（保证窗口有恰好 k 个数）</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> x;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; BIAS; j++) &#123; <span class="comment">// 暴力枚举负数范围 [-50,-1]</span></span><br><span class="line">                left -= cnt[j];</span><br><span class="line">                <span class="keyword">if</span> (left &lt;= <span class="number">0</span>) &#123; <span class="comment">// 找到美丽值</span></span><br><span class="line">                    ans[i - k + <span class="number">1</span>] = j - BIAS;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            cnt[nums[i - k + <span class="number">1</span>] + BIAS]--; <span class="comment">// 离开窗口</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="3439-重新安排会议得到最多时间"><a href="#3439-重新安排会议得到最多时间" class="headerlink" title="3439 重新安排会议得到最多时间"></a>3439 重新安排会议得到最多时间</h2><ul>
<li>给你一个整数 eventTime 表示一个活动的总时长，这个活动开始于 t &#x3D; 0 ，结束于 t &#x3D; eventTime 。<br>同时给你两个长度为 n 的整数数组 startTime 和 endTime 。它们表示这次活动中 n 个时间 没有重叠 的会议，其中第 i 个会议的时间为 [startTime[i], endTime[i]] 。<br>你可以重新安排 至多 k 个会议，安排的规则是将会议时间平移，且保持原来的 会议时长 ，你的目的是移动会议后 最大化 相邻两个会议之间的 最长 连续空余时间。<br>移动前后所有会议之间的 相对 顺序需要保持不变，而且会议时间也需要保持互不重叠。<br>请你返回重新安排会议以后，可以得到的 最大 空余时间。<br>注意，会议 不能 安排到整个活动的时间以外。</li>
<li>思路：详见注释<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maxFreeTime</span><span class="params">(<span class="type">int</span> eventTime, <span class="type">int</span> k, <span class="type">int</span>[] startTime, <span class="type">int</span>[] endTime)</span> &#123;</span><br><span class="line">        <span class="comment">// 在移动k个会议的情况下获取最长的空闲时间</span></span><br><span class="line">        <span class="comment">// 会议之间不会重叠</span></span><br><span class="line">        <span class="comment">// 移动会议本质上是把一个会议左右的空闲时间合并，可以理解为把右侧加到了左侧</span></span><br><span class="line">        <span class="comment">// 那么显然应该尝试连续移动，连续移动k个</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nowTime</span> <span class="operator">=</span> startTime[<span class="number">0</span>] - <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">maxTime</span> <span class="operator">=</span> startTime[<span class="number">0</span>] - <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">meetNum</span> <span class="operator">=</span> startTime.length;</span><br><span class="line">        <span class="comment">// 头尾加上两个节点</span></span><br><span class="line">        <span class="type">int</span>[] newStart = <span class="keyword">new</span> <span class="title class_">int</span>[meetNum + <span class="number">2</span>];</span><br><span class="line">        <span class="type">int</span>[] newEnd = <span class="keyword">new</span> <span class="title class_">int</span>[meetNum + <span class="number">2</span>];</span><br><span class="line">        newStart[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        newEnd[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        newStart[meetNum + <span class="number">1</span>] = eventTime;</span><br><span class="line">        newEnd[meetNum + <span class="number">1</span>] = eventTime;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= meetNum; i++) &#123;</span><br><span class="line">            newStart[i] = startTime[i - <span class="number">1</span>];</span><br><span class="line">            newEnd[i] = endTime[i - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 先移动k-1个, 也有可能不需要移动那么多</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= k; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">addTime</span> <span class="operator">=</span> i &lt;= meetNum ? newStart[i + <span class="number">1</span>] - newEnd[i] : <span class="number">0</span>;</span><br><span class="line">            nowTime += addTime;</span><br><span class="line">        &#125;</span><br><span class="line">        maxTime = Math.max(maxTime, nowTime);</span><br><span class="line">        <span class="comment">// 开始满足窗口</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> k + <span class="number">1</span>; i &lt;= meetNum ; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">addTime</span> <span class="operator">=</span> newStart[i + <span class="number">1</span>] - newEnd[i];</span><br><span class="line">            <span class="type">int</span> <span class="variable">outTime</span> <span class="operator">=</span> newStart[i - k] - newEnd[i - k - <span class="number">1</span>];</span><br><span class="line">            nowTime += addTime;</span><br><span class="line">            nowTime -= outTime;</span><br><span class="line">            maxTime = Math.max(maxTime, nowTime);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="不定长窗口"><a href="#不定长窗口" class="headerlink" title="不定长窗口"></a>不定长窗口</h1><p>不定长滑动窗口主要分为三类：求最长子数组，求最短子数组，以及求子数组个数。</p>
<ul>
<li>模版：两个指针，一个入新的元素，一个在满足条件后负责弹出元素</li>
<li>变化模场：取最左最右</li>
</ul>
<h2 id="3090-每个字符最多出现两次的最长子字符串"><a href="#3090-每个字符最多出现两次的最长子字符串" class="headerlink" title="3090 每个字符最多出现两次的最长子字符串"></a>3090 每个字符最多出现两次的最长子字符串</h2><ul>
<li>给你一个字符串 s ，请找出满足每个字符最多出现两次的最长子字符串，并返回该子字符串的最大长度。</li>
<li>思路：类似双指针，在满足条件后弹出元素，最外层还是循环控制好写一点<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maximumLengthSubstring</span><span class="params">(String S)</span> &#123;</span><br><span class="line">        <span class="type">char</span>[] s = S.toCharArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">ans</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span>[] cnt = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">26</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; s.length; i++) &#123; </span><br><span class="line">            <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> s[i] - <span class="string">&#x27;a&#x27;</span>; <span class="comment">// 进入</span></span><br><span class="line">            cnt[b]++;</span><br><span class="line">            <span class="keyword">while</span> (cnt[b] &gt; <span class="number">2</span>) &#123; <span class="comment">// 移动到满足</span></span><br><span class="line">                cnt[s[left++] - <span class="string">&#x27;a&#x27;</span>]--;</span><br><span class="line">            &#125;</span><br><span class="line">            ans = Math.max(ans, i - left + <span class="number">1</span>); <span class="comment">// 刚刚好满足的情况下处理</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="1658-把x减小到0的最小操作数目"><a href="#1658-把x减小到0的最小操作数目" class="headerlink" title="1658 把x减小到0的最小操作数目"></a>1658 把x减小到0的最小操作数目</h2><ul>
<li>给你一个整数数组 nums 和一个整数 x 。每一次操作时，你应当移除数组 nums 最左边或最右边的元素，然后从 x 中减去该元素的值。请注意，需要 修改 数组以供接下来的操作使用。如果可以将 x 恰好 减到 0 ，返回 最小操作数 ；否则，返回 -1 。</li>
<li>思路：还是经典双指针，但是要注意两个特殊判断：<code>sum&lt;x</code> 和 left 是否越界 – 其实就是不一定有窗口稳定态<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">minOperations</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> x)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> Integer.MAX_VALUE;</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">xLeft</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> n : nums) &#123;</span><br><span class="line">            sum += n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (sum &lt; x) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> <span class="number">0</span>; right &lt; nums.length; right++) &#123;</span><br><span class="line">            xLeft += nums[right];</span><br><span class="line">            <span class="keyword">while</span> (xLeft &gt; sum - x &amp;&amp; left &lt; nums.length) &#123;</span><br><span class="line">                xLeft -= nums[left++];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (xLeft == sum - x) &#123;</span><br><span class="line">                min = Math.min(nums.length - (right - left + <span class="number">1</span>), min);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> min == Integer.MAX_VALUE ? -<span class="number">1</span> :min;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2779-数组的最大美丽值"><a href="#2779-数组的最大美丽值" class="headerlink" title="2779 数组的最大美丽值"></a>2779 数组的最大美丽值</h2><ul>
<li>给你一个下标从 0 开始的整数数组 nums 和一个 非负 整数 k 。在一步操作中，你可以执行下述指令：<br>在范围 [0, nums.length - 1] 中选择一个 此前没有选过 的下标 i 。将 nums[i] 替换为范围 [nums[i] - k, nums[i] + k] 内的任一整数。数组的 美丽值 定义为数组中由相等元素组成的最长子序列的长度。<br>对数组 nums 执行上述操作任意次后，返回数组可能取得的 最大 美丽值。注意：你 只 能对每个下标执行 一次 此操作。<br>数组的 子序列 定义是：经由原数组删除一些元素（也可能不删除）得到的一个新数组，且在此过程中剩余元素的顺序不发生改变。</li>
<li>思路1：半径2k的区间进出问题<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maximumBeauty</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="comment">// 每一个数的替换范围是 [nums[i] - k, nums[i] + k]</span></span><br><span class="line">        <span class="comment">// 找到最大重复区间</span></span><br><span class="line">        <span class="comment">// 2k是半径</span></span><br><span class="line">        Arrays.sort(nums);</span><br><span class="line">        <span class="type">int</span> <span class="variable">nowStart</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nowEnd</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nowCnt</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                nowStart = nums[i] - k;</span><br><span class="line">                nowEnd = nums[i] + k;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> <span class="variable">newStart</span> <span class="operator">=</span> nums[i] - k;</span><br><span class="line">            <span class="type">int</span> <span class="variable">newEnd</span> <span class="operator">=</span> nums[i] + k;</span><br><span class="line">            <span class="keyword">if</span> (newStart &gt; nowEnd) &#123;</span><br><span class="line">                <span class="comment">// 现在长度是nowCnt</span></span><br><span class="line">                <span class="comment">// 第一个是i - nowCnt，不断移出第一个知道满足</span></span><br><span class="line">                <span class="keyword">while</span> (newStart &gt; nums[i - nowCnt] + k) &#123;</span><br><span class="line">                    nowCnt--;</span><br><span class="line">                &#125;</span><br><span class="line">                nowStart = newStart;</span><br><span class="line">                nowEnd = nums[i - nowCnt] + k;</span><br><span class="line">                nowCnt++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                nowStart = newStart;</span><br><span class="line">                nowCnt++;</span><br><span class="line">                max = Math.max(max, nowCnt);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>思路2：因此题目等价于找到最大最小值之差小于等于 2k 的最长连续子数组，该子数组的长度即为数组的最大美丽值。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maximumBeauty</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">0</span>, n = nums.length;</span><br><span class="line">        Arrays.sort(nums);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">while</span> (nums[i] - <span class="number">2</span> * k &gt; nums[j]) &#123;</span><br><span class="line">                j++;</span><br><span class="line">            &#125;</span><br><span class="line">            res = Math.max(res, i - j + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="1838-最高频元素的频率"><a href="#1838-最高频元素的频率" class="headerlink" title="1838 最高频元素的频率"></a>1838 最高频元素的频率</h2><ul>
<li>元素的 频数 是该元素在一个数组中出现的次数。给你一个整数数组 nums 和一个整数 k 。在一步操作中，你可以选择 nums 的一个下标，并将该下标对应元素的值增加 1 。执行最多 k 次操作后，返回数组中最高频元素的 最大可能频数 。</li>
<li>思路：排序 + 把每次进入窗口的作为要调整到的数字<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">maxFrequency</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        Arrays.sort(nums);</span><br><span class="line">        <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nowNum</span> <span class="operator">=</span> nums[<span class="number">0</span>];</span><br><span class="line">        <span class="type">long</span> <span class="variable">nowSum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nowCnt</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">nextNum</span> <span class="operator">=</span> nums[i];</span><br><span class="line">            nowSum += (<span class="type">long</span>)(nowCnt) * (nextNum - nowNum);</span><br><span class="line">            <span class="keyword">while</span> (nowSum &gt; k) &#123;</span><br><span class="line">                nowSum -= (nextNum - nums[i - nowCnt]);</span><br><span class="line">                nowCnt--; </span><br><span class="line">            &#125;</span><br><span class="line">            nowCnt++;</span><br><span class="line">            nowNum = nextNum;</span><br><span class="line">            </span><br><span class="line">            max = (<span class="type">int</span>)Math.max(max, nowCnt);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2516-每种字符至少取k个"><a href="#2516-每种字符至少取k个" class="headerlink" title="2516 每种字符至少取k个"></a>2516 每种字符至少取k个</h2><ul>
<li>给你一个由字符 ‘a’、’b’、’c’ 组成的字符串 s 和一个非负整数 k 。每分钟，你可以选择取走 s 最左侧 还是 最右侧 的那个字符。你必须取走每种字符 至少 k 个，返回需要的 最少 分钟数；如果无法取到，则返回 -1 </li>
<li>思路：左右两侧至少取k个的最小长度 - 中间至多有ni-k个的最大长度<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">takeCharacters</span><span class="params">(String s, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="comment">// 最少取走k个每种</span></span><br><span class="line">        <span class="comment">// 最长的至多ni-k个</span></span><br><span class="line">        <span class="type">char</span>[] cs = s.toCharArray();</span><br><span class="line">        <span class="type">int</span>[] cnt = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">26</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> c : cs) &#123;</span><br><span class="line">            cnt[c - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cnt[<span class="number">0</span>] &lt; k || cnt[<span class="number">1</span>] &lt; k || cnt[<span class="number">2</span>] &lt; k) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span>[] now = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">26</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> <span class="number">0</span>; right &lt; cs.length; right++) &#123;</span><br><span class="line">            now[cs[right] - <span class="string">&#x27;a&#x27;</span>]++;</span><br><span class="line">            <span class="keyword">while</span> (now[cs[right] - <span class="string">&#x27;a&#x27;</span>] &gt; cnt[cs[right] - <span class="string">&#x27;a&#x27;</span>] - k &amp;&amp; left &lt;= right) &#123;</span><br><span class="line">                now[cs[left] - <span class="string">&#x27;a&#x27;</span>]--;</span><br><span class="line">                left++;</span><br><span class="line">            &#125;</span><br><span class="line">            max = Math.max(right - left + <span class="number">1</span>, max);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max == -<span class="number">1</span> ? -<span class="number">1</span> : cs.length - max;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="2831-找出最长等值子数组"><a href="#2831-找出最长等值子数组" class="headerlink" title="2831 找出最长等值子数组"></a>2831 找出最长等值子数组</h2><ul>
<li>给你一个下标从 0 开始的整数数组 nums 和一个整数 k 。如果子数组中所有元素都相等，则认为子数组是一个 等值子数组 。注意，空数组是 等值子数组 。从 nums 中删除最多 k 个元素后，返回可能的最长等值子数组的长度。子数组 是数组中一个连续且可能为空的元素序列。</li>
<li>思路：找到一个窗口之后，只需要更大的窗口<br>关键点是：对于这种频率记录且要始终获取最大频率的问题，要先想想到底是不是真的一直需要当前最大频率，是不是可能只要历史最大频率就行了<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">longestEqualSubarray</span><span class="params">(List&lt;Integer&gt; nums, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> nums.size();</span><br><span class="line">        <span class="type">int</span>[] freq = <span class="keyword">new</span> <span class="title class_">int</span>[n + <span class="number">10</span>]; <span class="comment">// 记录每个数字出现的频率</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">maxFreq</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 当前窗口内出现次数最多的数字的频率</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>, right = <span class="number">0</span>; <span class="comment">// 左右指针</span></span><br><span class="line">        <span class="keyword">while</span> (right &lt; n) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> nums.get(right++); <span class="comment">// 获取当前右指针对应的数字，并右移</span></span><br><span class="line">            freq[num]++; <span class="comment">// 更新该数字的频率</span></span><br><span class="line">            maxFreq = Math.max(freq[num], maxFreq); <span class="comment">// 更新窗口内的最大频率</span></span><br><span class="line">            <span class="comment">// 这样理解：找到一个窗口之后，就只需要找更大的窗口</span></span><br><span class="line">            <span class="comment">// 如果进来的是一个原先的最高频率数字，不影响</span></span><br><span class="line">            <span class="comment">// 如果进来的是一个能出现新的最高频数字的数字，不影响，相当于判断左右+1</span></span><br><span class="line">            <span class="comment">// 如果进来的是一个其他数字，可能要去循环</span></span><br><span class="line">            <span class="comment">// 如果当前窗口长度减去最多频数字的次数超过允许替换的次数 k，缩小窗口</span></span><br><span class="line">            <span class="keyword">while</span> (right - left  &gt; maxFreq + k) &#123;</span><br><span class="line">                freq[nums.get(left++)]--; <span class="comment">// 左指针右移，并减少移出数字的频率</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> maxFreq; <span class="comment">// 返回窗口内最多频数字的频率</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
还有一种类似双指针的思路：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 思路：以当前结点为右边界，在确定其左边界</span></span><br><span class="line"><span class="comment">// 用cnt记录每个数的数量</span></span><br><span class="line"><span class="comment">// l表示左边界，r表示右边界</span></span><br><span class="line"><span class="comment">// 则r-l+1-cnt[nums[i]]就是窗口中非nums[i]的个数</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">longestEqualSubarray</span><span class="params">(<span class="type">int</span>* nums, <span class="type">int</span> numsSize, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> n = numsSize;</span><br><span class="line">    <span class="type">int</span> cnt[n + <span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> ans = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(cnt, <span class="number">0</span>, <span class="keyword">sizeof</span>(cnt));</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> l = <span class="number">0</span>, r = <span class="number">0</span>; r &lt; n; r++) &#123;</span><br><span class="line">        cnt[nums[r]]++;</span><br><span class="line">        <span class="comment">// 什么时候淘汰左边界？</span></span><br><span class="line">        <span class="comment">// 窗口-cnt[nums[l]]&gt;k 淘汰</span></span><br><span class="line">        <span class="keyword">while</span> (r - l + <span class="number">1</span> - cnt[nums[l]] &gt; k) &#123;</span><br><span class="line">            cnt[nums[l++]]--;</span><br><span class="line">        &#125;</span><br><span class="line">        ans = fmax(ans, cnt[nums[r]]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ans;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/02/27/LeetCode%E5%88%B7%E9%A2%98-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/" data-id="cm7qdvwzg0007jsvc0ozzad98" data-title="LeetCode刷题-滑动窗口" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Debian包构建" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/12/23/Debian%E5%8C%85%E6%9E%84%E5%BB%BA/" class="article-date">
  <time class="dt-published" datetime="2024-12-23T06:41:29.000Z" itemprop="datePublished">2024-12-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/12/23/Debian%E5%8C%85%E6%9E%84%E5%BB%BA/">Debian包构建</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>ubuntu系统的包构建，ubuntu是基于debian开发的<br><a target="_blank" rel="noopener" href="https://ubuntu.com/server/docs/package-management">https://ubuntu.com/server/docs/package-management</a> </p>
<p>debain的包构建<br><a target="_blank" rel="noopener" href="https://www.debian.org/doc/manuals/debmake-doc/ch05.zh-cn.html#packaging-tarball">https://www.debian.org/doc/manuals/debmake-doc/ch05.zh-cn.html#packaging-tarball</a></p>
<h2 id="打包流程"><a href="#打包流程" class="headerlink" title="打包流程"></a>打包流程</h2><h3 id="非系统文件的安装"><a href="#非系统文件的安装" class="headerlink" title="非系统文件的安装"></a>非系统文件的安装</h3><ul>
<li>假设一个c项目，使用makefile构建，最后被打包为一个tar.gz压缩包</li>
<li>我们可以这样安装它<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -xzmf debhello-0.0.tar.gz</span><br><span class="line">cd debhello-0.0</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<ul>
<li>其中make命令编译了源代码，生成二进制文件或库（.a、.so）</li>
<li>make install命令把生成好的文件和程序复制到系统目录，使得其可以全局访问。install的规则当然需要开发者自己编写makefile</li>
</ul>
</li>
</ul>
<h3 id="构建非原生debian包"><a href="#构建非原生debian包" class="headerlink" title="构建非原生debian包"></a>构建非原生debian包</h3><ul>
<li>流程：<ol>
<li>解压源码压缩包</li>
<li>debmake，对上游源码树debian化，创建一个debian目录并添加模版文件：名为 debhello_0.0.orig.tar.gz 的符号链接被创建并指向 debhello-0.0.tar.gz文件。维护者须自行编辑修改模板文件。</li>
<li>debuild，基于已经debian化的源码树构建二进制软件包：debhello-0.0-1.debian.tar.xz 将被创建，它包含了 debian 目录。</li>
</ol>
</li>
<li>debmake会在项目源码内添加一些模版文件<br><img src="/2024/12/23/Debian%E5%8C%85%E6%9E%84%E5%BB%BA/debmake.png" alt="alt text"><ul>
<li>比较重要的两个文件是rules和control，前者是由软件包提供者维护的构建脚本，后者包含了软件包的主要元信息</li>
<li>作为软件包开发者，应该维护这些模版文件</li>
<li>control内包含依赖（构建&amp;运行时）：<ul>
<li>运行时依赖：<code>Depends: $&#123;misc:Depends&#125;, $&#123;shlibs:Depends&#125;</code><ul>
<li><code>$&#123;misc:Depends&#125;</code> 是一个占位符，它代表了通常用于任何 Debian 软件包的通用依赖。这些依赖通常是由 debhelper 或其他工具自动管理的。具体来说，它通常包括一些和包构建、安装及管理相关的基本工具和库，但它的实际内容取决于使用的构建工具和配置。<code>$&#123;shlibs:Depends&#125;</code> 是另一个占位符，用于指定软件包所依赖的共享库（shared libraries）。shlibs 是 “shared libraries” 的缩写，它会根据包中链接的共享库来自动生成相应的依赖项。例如，如果你的软件包链接到某个库（如 libc），那么 shlibs:Depends 会自动处理这些依赖关系。</li>
</ul>
</li>
<li>构建依赖：<code>Build-Depends: debhelper-compat (= 12) </code><ul>
<li>这代表我们在构建软件包，也就是打包生成可执行文件的时候需要的依赖</li>
</ul>
</li>
<li>一个例子，例如我们include了stdio，它可能就在Debian的通用依赖里面（libc），以动态形式链接</li>
</ul>
</li>
</ul>
</li>
<li>debuild会执行构建过程，构建产物如下<br><img src="/2024/12/23/Debian%E5%8C%85%E6%9E%84%E5%BB%BA/debuild%E4%BA%A7%E7%89%A9.png" alt="alt text"><br><img src="/2024/12/23/Debian%E5%8C%85%E6%9E%84%E5%BB%BA/debuild%E4%BA%A7%E7%89%A9-2.png" alt="alt text"><br>deb文件内就是软件包内容了，包含了将要安装至目标系统中的文件。<br><img src="/2024/12/23/Debian%E5%8C%85%E6%9E%84%E5%BB%BA/deb%E5%8C%85%E5%86%85%E5%AE%B9.png" alt="alt text"></li>
<li>生成需要的依赖：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dpkg -f debhello_0.0-1_amd64.deb pre-depends \</span><br><span class="line">        depends recommends conflicts breaks</span><br></pre></td></tr></table></figure></li>
<li>可能的问题：<ul>
<li>如果你复制makefile，注意tab和空格，如果使用了空格作为分隔，要改为tab（注意编辑器可能直接把tab设置为了空格）</li>
<li>注意整个过程中不要再改源文件了</li>
</ul>
</li>
</ul>
<h3 id="打包工作流"><a href="#打包工作流" class="headerlink" title="打包工作流"></a>打包工作流</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.debian.org/doc/manuals/debmake-doc/ch06.zh-cn.html">https://www.debian.org/doc/manuals/debmake-doc/ch06.zh-cn.html</a></li>
</ul>
<h3 id="安装与运行"><a href="#安装与运行" class="headerlink" title="安装与运行"></a>安装与运行</h3><ul>
<li>安装：<code>sudo apt install xx.deb</code></li>
<li>运行：<code>dkpg -L xx</code>，可以直接找到bin内这个软件包的目录</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/12/23/Debian%E5%8C%85%E6%9E%84%E5%BB%BA/" data-id="cm7qdvwz10000jsvcga4vedfi" data-title="Debian包构建" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-MySql-分库分表" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/12/18/MySql-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" class="article-date">
  <time class="dt-published" datetime="2024-12-18T01:54:18.000Z" itemprop="datePublished">2024-12-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>►<a class="article-category-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/">Mysql</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/12/18/MySql-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">MySql-分库分表</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="分库分表操作"><a href="#分库分表操作" class="headerlink" title="分库分表操作"></a>分库分表操作</h2><ul>
<li>垂直拆分：指按照业务将表进行分类，分布到不同的数据库上，这样也就将数据的压力分担到不同的库上面。最终一个数据库由很多表的构成，每个表对应着不同的业务，也就是专库专用。</li>
<li>水平拆分：如果垂直拆分后遇到单机瓶颈，可以使用水平拆分。相对于垂直拆分的区别是：垂直拆分是把不同的表拆到不同的数据库中，而水平拆分是把同一个表拆到不同的数据库中。如：user_001、user_002</li>
</ul>
<h3 id="设计实现"><a href="#设计实现" class="headerlink" title="设计实现"></a>设计实现</h3><ul>
<li><p>定义路由注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DBRouter &#123;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">key</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用自定义路由注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserDao</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DBRouter(key = &quot;userId&quot;)</span></span><br><span class="line">    User <span class="title function_">queryUserInfoByUserId</span><span class="params">(User req)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DBRouter(key = &quot;userId&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User req)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>路由配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">router:</span></span><br><span class="line">    <span class="attr">jdbc:</span></span><br><span class="line">        <span class="attr">datasource:</span></span><br><span class="line">            <span class="attr">dbCount:</span> <span class="number">2</span></span><br><span class="line">            <span class="attr">tbCooun:</span> <span class="number">4</span></span><br><span class="line">            <span class="attr">list:</span> <span class="string">db01,</span> <span class="string">db02</span></span><br><span class="line">            <span class="attr">db01:</span> </span><br><span class="line">                <span class="attr">dirver-class-name:</span> <span class="string">com.mysql.jbdc.Driver</span></span><br><span class="line">                <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/bugstack_01?useUnicode=true</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">            <span class="attr">db02:</span> </span><br><span class="line">                <span class="attr">dirver-class-name:</span> <span class="string">com.mysql.jbdc.Driver</span></span><br><span class="line">                <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/bugstack_02?useUnicode=true</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">                <span class="attr">password:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>数据源配置</p>
<ul>
<li>提取数据源：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnvironment</span><span class="params">(Environment environment)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> <span class="string">&quot;router.jdbc.datasource.&quot;</span>;    </span><br><span class="line"></span><br><span class="line">    dbCount = Integer.valueOf(environment.getProperty(prefix + <span class="string">&quot;dbCount&quot;</span>));</span><br><span class="line">    tbCount = Integer.valueOf(environment.getProperty(prefix + <span class="string">&quot;tbCount&quot;</span>));    </span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">dataSources</span> <span class="operator">=</span> environment.getProperty(prefix + <span class="string">&quot;list&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (String dbInfo : dataSources.split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; dataSourceProps = PropertyUtil.handle(environment, prefix + dbInfo, Map.class);</span><br><span class="line">        dataSourceMap.put(dbInfo, dataSourceProps);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>数据源切换<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 创建数据源</span></span><br><span class="line">    Map&lt;Object, Object&gt; targetDataSources = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String dbInfo : dataSourceMap.keySet()) &#123;</span><br><span class="line">        Map&lt;String, Object&gt; objMap = dataSourceMap.get(dbInfo);</span><br><span class="line">        targetDataSources.put(dbInfo, <span class="keyword">new</span> <span class="title class_">DriverManagerDataSource</span>(objMap.get(<span class="string">&quot;url&quot;</span>).toString(), objMap.get(<span class="string">&quot;username&quot;</span>).toString(), objMap.get(<span class="string">&quot;password&quot;</span>).toString()));</span><br><span class="line">    &#125;     </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置数据源</span></span><br><span class="line">    <span class="type">DynamicDataSource</span> <span class="variable">dynamicDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DynamicDataSource</span>();</span><br><span class="line">    dynamicDataSource.setTargetDataSources(targetDataSources);</span><br><span class="line">    <span class="keyword">return</span> dynamicDataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>切面拦截<ol>
<li>首先我们提取了库表乘积的数量，把它当成 HashMap 一样的长度进行使用。</li>
<li>接下来使用和 HashMap 一样的扰动函数逻辑，让数据分散的更加散列。</li>
<li>当计算完总长度上的一个索引位置后，还需要把这个位置折算到库表中，看看总体长度的索引因为落到哪个库哪个表。</li>
<li>最后是把这个计算的索引信息存放到 ThreadLocal 中，用于传递在方法调用过程中可以提取到索引信息。 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around(&quot;aopPoint() &amp;&amp; @annotation(dbRouter)&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">doRouter</span><span class="params">(ProceedingJoinPoint jp, DBRouter dbRouter)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">dbKey</span> <span class="operator">=</span> dbRouter.key();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(dbKey)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;annotation DBRouter key is null！&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算路由</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">dbKeyAttr</span> <span class="operator">=</span> getAttrValue(dbKey, jp.getArgs());</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> dbRouterConfig.getDbCount() * dbRouterConfig.getTbCount();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 扰动函数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> (size - <span class="number">1</span>) &amp; (dbKeyAttr.hashCode() ^ (dbKeyAttr.hashCode() &gt;&gt;&gt; <span class="number">16</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 库表索引</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dbIdx</span> <span class="operator">=</span> idx / dbRouterConfig.getTbCount() + <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">tbIdx</span> <span class="operator">=</span> idx - dbRouterConfig.getTbCount() * (dbIdx - <span class="number">1</span>);   </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置到 ThreadLocal</span></span><br><span class="line">    DBContextHolder.setDBKey(String.format(<span class="string">&quot;%02d&quot;</span>, dbIdx));</span><br><span class="line">    DBContextHolder.setTBKey(String.format(<span class="string">&quot;%02d&quot;</span>, tbIdx));</span><br><span class="line">    logger.info(<span class="string">&quot;数据库路由 method：&#123;&#125; dbIdx：&#123;&#125; tbIdx：&#123;&#125;&quot;</span>, getMethod(jp).getName(), dbIdx, tbIdx);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回结果</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jp.proceed();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        DBContextHolder.clearDBKey();</span><br><span class="line">        DBContextHolder.clearTBKey();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="完整实现思路"><a href="#完整实现思路" class="headerlink" title="完整实现思路"></a>完整实现思路</h3><ul>
<li>实现EnvironmentAware类，在里面创建并设置数据源</li>
<li>设计一个Context类，用ThreadLocal存储dbKey</li>
<li>设置切面，在执行数据库方法前设置context的ThreadLocal变量</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/12/18/MySql-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" data-id="cm4tml8ci0000zwvcfi9kdomb" data-title="MySql-分库分表" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-TCP-IP" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/12/17/TCP-IP/" class="article-date">
  <time class="dt-published" datetime="2024-12-17T05:53:22.000Z" itemprop="datePublished">2024-12-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/12/17/TCP-IP/">TCP/IP</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="socket"><a href="#socket" class="headerlink" title="socket"></a>socket</h2><ul>
<li>Socket是应用层与TCP&#x2F;IP协议族通信的中间软件抽象层，它是一组接口。在设计模式中，Socket其实就是一个门面模式，它把复杂的TCP&#x2F;IP协议族隐藏在Socket接口后面，对用户来说，一组简单的接口就是全部，让Socket去组织数据，以符合指定的协议。实际上socket可以说是对TCP&#x2F;IP协议的封装，Socket本身并不是协议，而是一个调用接口(API)。socket则是对TCP&#x2F;IP协议的封装和应用(程序员层面上)。也可以说，TPC&#x2F;IP协议是传输层协议，主要解决数据如何在网络中传输，而HTTP是应用层协议，主要解决如何包装数据。关于TCP&#x2F;IP和HTTP协议的关系，网络有一段比较容易理解的介绍:“我们在传输数据时，可以只使用(传输层)TCP&#x2F;IP协议，但是那样的话，如果没有应用层，便无法识别数据内容。如果想要使传输的数据有意义，则必须使用到应用层协议。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/12/17/TCP-IP/" data-id="cm4s8hpvh0004acvc3cvz9igv" data-title="TCP/IP" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LCR119/">LCR119</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode101/">LeetCode101</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode101/%E5%9B%9E%E6%BA%AF/">回溯</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode101/%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2/">深度优先搜索</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode%E5%88%B7%E9%A2%98/">LeetCode刷题</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode%E5%88%B7%E9%A2%98/Hot100/">Hot100</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode%E5%88%B7%E9%A2%98/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3/">滑动窗口</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Makefile/">Makefile</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/REDIS/">REDIS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/Dubbo/">Dubbo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/Kafka/">Kafka</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/MIT-6824/">MIT-6824</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/RabbitMQ/">RabbitMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/RocketMQ/">RocketMQ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/">任务调度</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">系统架构</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/CSS/">CSS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/HTML/">HTML</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/TypeScript/">TypeScript</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%9E%E4%B9%A0/">实习</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%9E%E4%B9%A0/baosight/">baosight</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%9E%E4%B9%A0/baosight/OPC-UA/">OPC_UA</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E6%BA%90%E7%A4%BE%E5%8C%BA/">开源社区</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E7%BD%91%E7%BB%9C%E7%B3%BB%E7%BB%9F/">网络系统</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/SQL/">SQL</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%B8%B8%E5%BC%80%E5%8F%91/">日常开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A7%91%E7%A0%94/">科研</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A7%91%E7%A0%94/ImageMatchingfromHandcraftedtoDeepFeatures-ASurvey/">ImageMatchingfromHandcraftedtoDeepFeatures:ASurvey</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%88%86%E6%B2%BB/">分治</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">动态规划</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%8D%95%E8%B0%83%E6%A0%88/">单调栈</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/%E5%B8%B8%E7%94%A8%E7%AE%97%E6%B3%95/">常用算法</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BE%E7%A8%8B/">课程</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AF%BE%E7%A8%8B/%E8%BD%AF%E4%BB%B6%E8%AE%BE%E8%AE%A1/">软件设计</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/%E6%8F%8F%E8%BF%B0%E4%B8%8E%E9%9D%A2%E8%AF%95/">描述与面试</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE/%E6%AF%95%E8%AE%BE/">毕设</a></li></ul></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">March 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/02/">February 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">December 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/10/">October 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/03/06/JAVA%E7%BA%BF%E7%A8%8B%E6%B1%A0/">JAVA线程池</a>
          </li>
        
          <li>
            <a href="/2025/03/04/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E6%A8%A1%E7%89%88/">设计模式模版</a>
          </li>
        
          <li>
            <a href="/2025/03/03/%E6%AF%95%E8%AE%BE-%E5%90%8E%E7%AB%AF%E4%B8%8E%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95/">毕设-后端与核心算法</a>
          </li>
        
          <li>
            <a href="/2025/03/02/Mysql-%E9%94%81%E6%9C%BA%E5%88%B6/">Mysql-锁机制</a>
          </li>
        
          <li>
            <a href="/2025/03/02/Maven/">Maven</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>